"""
Автоматично згенеровані тести для {{ processor_name }} (v2.16.0+)

Цей файл створений test_generator.py на основі tests.yaml конфігурації.
НЕ РЕДАГУЙТЕ ВРУЧНУ - зміни будуть перезаписані при наступній генерації.
"""

import pytest
import logging
import sys
import importlib.util
from pathlib import Path

logger = logging.getLogger(__name__)

# Import models from parent (handling module name with digit)
# Path: .../tmp/ProcessorName/tests/test_*.py
# Need: .../1c-processor-generator/
project_root = Path(__file__).parent.parent.parent.parent
sys.path.insert(0, str(project_root))

# Import 1c_processor_generator.models using importlib
models_module = importlib.import_module("1c_processor_generator.models")

DeclarativeTest = models_module.DeclarativeTest
TestSetup = models_module.TestSetup
TestAssertion = models_module.TestAssertion
MessageAssertion = models_module.MessageAssertion
TableAssertion = models_module.TableAssertion
ExceptionAssertion = models_module.ExceptionAssertion

# ===== Declarative Tests =====

{% if declarative_tests %}
class TestDeclarative:
    """Декларативні тести з tests.yaml"""

    {% for test in declarative_tests %}
    def {{ test.name }}(self, processor):
        """
        {{ test.description or 'Auto-generated test from YAML' }}
        """
        # Створюємо test config
        test_config = DeclarativeTest(
            name="{{ test.name }}",
            description={{ repr(test.description) }},
            {% if test.setup %}
            setup=TestSetup(
                attributes={{ test.setup.attributes }},
                table_rows={{ test.setup.table_rows }},
            ),
            {% else %}
            setup=None,
            {% endif %}
            {% if test.execute_command %}
            execute_command="{{ test.execute_command }}",
            {% else %}
            execute_command=None,
            {% endif %}
            {% if test.execute_procedure %}
            execute_procedure="{{ test.execute_procedure }}",
            {% else %}
            execute_procedure=None,
            {% endif %}
            {% if test.assert_result %}
            assert_result=TestAssertion(
                attributes={{ test.assert_result.attributes }},
                {% if test.assert_result.messages %}
                messages=[
                    {% for msg in test.assert_result.messages %}
                    MessageAssertion(
                        contains={{ repr(msg.contains) }},
                        equals={{ repr(msg.equals) }},
                        count={{ msg.count }},
                    ),
                    {% endfor %}
                ],
                {% else %}
                messages=[],
                {% endif %}
                {% if test.assert_result.tables %}
                tables=[
                    {% for tbl in test.assert_result.tables %}
                    TableAssertion(
                        table_name="{{ tbl.table_name }}",
                        row_count={{ tbl.row_count }},
                        columns={{ tbl.columns }},
                        row_data={{ tbl.row_data }},
                    ),
                    {% endfor %}
                ],
                {% else %}
                tables=[],
                {% endif %}
                {% if test.assert_result.exception %}
                exception=ExceptionAssertion(
                    raised={{ test.assert_result.exception.raised }},
                    contains={{ repr(test.assert_result.exception.contains) }},
                ),
                {% else %}
                exception=None,
                {% endif %}
            ),
            {% else %}
            assert_result=None,
            {% endif %}
        )

        # Виконуємо тест
        result = processor.run_declarative_test(test_config)

        # Assert результат
        assert result.passed, f"Тест провалився: {result.error_message}"

    {% endfor %}
{% endif %}

# ===== Procedural Tests (BSL) =====

{% if procedural_tests and procedural_tests.procedures %}
class TestProcedural:
    """Процедурні тести з BSL файлу"""

    {% for procedure in procedural_tests.procedures %}
    def test_{{ procedure.lower().replace('тест_', '').replace('test_', '') }}(self, processor):
        """
        BSL процедура: {{ procedure }}
        """
        result = processor.run_procedural_test("{{ procedure }}")

        assert result.passed, f"Тест провалився: {result.error_message}"

    {% endfor %}
{% endif %}

# ===== Test Summary =====

def test_summary(processor):
    """Фінальний тест - виводить статистику"""
    logger.info("\n" + "="*60)
    logger.info("ТЕСТУВАННЯ ЗАВЕРШЕНО")
    logger.info("="*60)
    logger.info(f"EPF: {{ processor_name }}")
    logger.info(f"Declarative tests: {{ declarative_tests|length if declarative_tests else 0 }}")
    logger.info(f"Procedural tests: {{ procedural_tests.procedures|length if procedural_tests and procedural_tests.procedures else 0 }}")
    logger.info("="*60)
