//
// Модуль об'єкта validator.epf
// Точка входу при запуску через /Execute /C"путь_к_epf"
//

// ============================================================================
// КОМАНДНА СТРОКА: Точка входу при запуску через /Execute /C"путь_к_epf"
// ============================================================================

ПараметрЗапуска = "";

Попытка
    // Отримуємо параметр з командної строки через /C
    ПараметрыПриложения = ПараметрыСеанса.ПараметрыКлиентаНаСервере;

    Если ТипЗнч(ПараметрыПриложения) = Тип("Соответствие") Тогда
        Если ПараметрыПриложения.Свойство("ЗапускКоманднойСтроки") Тогда
            ПараметрЗапуска = ПараметрыПриложения.ЗапускКоманднойСтроки;
        КонецЕсли;
    КонецЕсли;

    // Якщо параметр не отримано, пробуємо інший спосіб
    Если ПустаяСтрока(ПараметрЗапуска) Тогда
        ПараметрЗапуска = ПараметрыСеанса.ПараметрыКлиентаНаСервере;
    КонецЕсли;

Исключение
    // Ігноруємо помилки отримання параметрів
КонецПопытки;

// Якщо є параметр командної строки - запускаємо перевірку
Если НЕ ПустаяСтрока(ПараметрЗапуска) Тогда
    ПроверитьСинтаксисEPFПрограммно(ПараметрЗапуска);
КонецЕсли;

// ============================================================================
// ОСНОВНАЯ ЛОГИКА ВАЛИДАЦИИ
// ============================================================================

&НаСервереБезКонтекста
Процедура ПроверитьСинтаксисEPFПрограммно(ПутьКФайлу)

    Сообщить("================================================================================");
    Сообщить("EPF Syntax Validator");
    Сообщить("================================================================================");
    Сообщить("");

    // Перевірка існування файлу
    ФайлEPF = Новый Файл(ПутьКФайлу);

    Если НЕ ФайлEPF.Существует() Тогда
        Сообщить("✗ ПОМИЛКА: Файл не знайдено");
        Сообщить("  Шлях: " + ПутьКФайлу);
        Сообщить("");
        Сообщить("Exit code: 1");
        ВызватьИсключение "Файл не найден: " + ПутьКФайлу;
    КонецЕсли;

    Сообщить("Перевірка файлу: " + ФайлEPF.Имя);
    Сообщить("Повний шлях: " + ФайлEPF.ПолноеИмя);
    Сообщить("Розмір: " + Формат(ФайлEPF.Размер() / 1024, "ЧЦ=10; ЧДЦ=2") + " KB");
    Сообщить("");

    // Спроба завантажити EPF
    Попытка

        Сообщить("Завантаження EPF...");

        НачалоВремени = ТекущаяУниверсальнаяДатаВМиллисекундах();

        // КРИТИЧНА ОПЕРАЦІЯ: Завантаження EPF
        // Якщо є синтаксичні помилки - тут буде виняток
        ВнешняяОбработка = ВнешниеОбработки.Создать(ПутьКФайлу);

        ВремяЗагрузки = (ТекущаяУниверсальнаяДатаВМиллисекундах() - НачалоВремени) / 1000;

        Сообщить("✓ Завантаження успішне (" + Формат(ВремяЗагрузки, "ЧЦ=10; ЧДЦ=3") + "s)");
        Сообщить("");

        // Отримання метаданих обробки
        МетаданныеОбработки = ВнешняяОбработка.Метаданные();

        Сообщить("Інформація про обробку:");
        Сообщить("  Тип: " + ТипЗнч(ВнешняяОбработка));
        Сообщить("  Ім'я: " + МетаданныеОбработки.Имя);

        Если НЕ ПустаяСтрока(МетаданныеОбработки.Синоним) Тогда
            Сообщить("  Синонім: " + МетаданныеОбработки.Синоним);
        КонецЕсли;

        Если НЕ ПустаяСтрока(МетаданныеОбработки.Комментарий) Тогда
            Сообщить("  Коментар: " + МетаданныеОбработки.Комментарий);
        КонецЕсли;

        // Підрахунок елементів
        КоличествоРеквизитов = МетаданныеОбработки.Реквизиты.Количество();
        КоличествоФорм = МетаданныеОбработки.Формы.Количество();
        КоличествоКоманд = МетаданныеОбработки.Команды.Количество();

        Сообщить("  Реквізити: " + КоличествоРеквизитов);
        Сообщить("  Форми: " + КоличествоФорм);
        Сообщить("  Команди: " + КоличествоКоманд);

        Сообщить("");
        Сообщить("================================================================================");
        Сообщить("✓ ПЕРЕВІРКА ПРОЙДЕНА УСПІШНО");
        Сообщить("================================================================================");
        Сообщить("");
        Сообщить("Файл EPF синтаксично коректний і може бути завантажений в 1С:Підприємство.");
        Сообщить("");
        Сообщить("ПРИМІТКА: Це базова перевірка, що виявляє тільки критичні синтаксичні помилки.");
        Сообщить("Для повної перевірки (відсутні методи, type errors тощо) використовуйте");
        Сообщить("розширену валідацію через Extension + синтаксична перевірка.");
        Сообщить("");
        Сообщить("Exit code: 0");

    Исключение

        // Помилка завантаження EPF
        ИнфоОбОшибке = ИнформацияОбОшибке();

        Сообщить("================================================================================");
        Сообщить("✗ ПОМИЛКА СИНТАКСИСУ");
        Сообщить("================================================================================");
        Сообщить("");
        Сообщить("Файл EPF містить синтаксичні помилки і не може бути завантажений.");
        Сообщить("");
        Сообщить("Детальний опис помилки:");
        Сообщить("────────────────────────────────────────────────────────────────────────────────");

        // Короткий опис
        Сообщить(КраткоеПредставлениеОшибки(ИнфоОбОшибке));
        Сообщить("");

        // Детальний опис
        Сообщить("Повна інформація:");
        Сообщить(ПодробноеПредставлениеОшибки(ИнфоОбОшибке));

        Сообщить("────────────────────────────────────────────────────────────────────────────────");
        Сообщить("");
        Сообщить("Exit code: 1");

        // Викидаємо виняток для Python (exit code 1)
        ВызватьИсключение ПодробноеПредставлениеОшибки(ИнфоОбОшибке);

    КонецПопытки;

КонецПроцедуры
