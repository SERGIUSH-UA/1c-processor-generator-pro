# 1C Processor Generator - Knowledge Base

> Повний довідник для генерації без помилок. Доповнює Instructions.

---

## Зарезервовані слова BSL (ПОВНИЙ СПИСОК)

**НІКОЛИ не використовуй як handler name:**

```
Выполнить, Экспорт, Импорт, Процедура, Функция, КонецПроцедуры, КонецФункции,
Прервать, Продолжить, Возврат, Если, Тогда, ИначеЕсли, Иначе, КонецЕсли,
Для, По, Пока, Цикл, КонецЦикла, Каждого, Из, Попытка, Исключение,
ВызватьИсключение, КонецПопытки, Новый, Перем, Знач, И, Или, Не,
Истина, Ложь, Неопределено, NULL
```

**Фікс - додай контекст:**
| ❌ Зарезервоване | ✅ Правильно |
|-----------------|-------------|
| `Выполнить` | `ВыполнитьОбработку` |
| `Экспорт` | `ЭкспортироватьДанные` |
| `Импорт` | `ИмпортироватьФайл` |
| `Возврат` | `ВернутьРезультат` |
| `Прервать` | `ПрерватьОперацию` |

---

## Українська кирилиця - ЗАБОРОНЕНІ літери

**В ідентифікаторах (name, handler) ТІЛЬКИ російська:**

| ❌ Українська | ✅ Російська | Буква |
|--------------|-------------|-------|
| `Професійний` | `Профессиональный` | і→и |
| `Компанії` | `Компании` | і→и |
| `Їжа` | `Еда` | ї→е |
| `Європа` | `Европа` | є→е |
| `Ґрунт` | `Грунт` | ґ→г |
| `Пошуковий` | `Поисковый` | і→и |

**Де українська OK:**
- `synonym_uk: "Пошуковий запит"` ✅
- `title_uk: "Виконати"` ✅
- `tooltip_uk: "Підказка"` ✅
- BSL strings: `Сообщить("Готово!")` ✅

---

## form_attributes vs attributes (КРИТИЧНО!)

| Секція | Зберігання | Доступ BSL | Типи |
|--------|------------|------------|------|
| `attributes:` | Персистентно в об'єкті | `Объект.Имя` | string, number, date, boolean, CatalogRef, DocumentRef |
| `form_attributes:` | Тимчасово на формі | `Имя` | spreadsheet_document, binary_data, string (для HTML), planner |

```yaml
# ✅ ПРАВИЛЬНО
attributes:
  - name: НазваниеКомпании
    type: string
  - name: Сумма
    type: number
    digits: 15
    fraction_digits: 2

forms:
  - name: Форма
    default: true
    form_attributes:              # ВСЕРЕДИНІ form!
      - name: ОтчетТабличный
        type: spreadsheet_document
      - name: HTMLКонтент
        type: string              # ⚠️ Для HTMLDocumentField!
```

**❌ ПОМИЛКА:** `SpreadsheetDocument` в `attributes:` → runtime error!

---

## Типи даних (повний список)

### Прості типи
```yaml
# String необмежений
- name: Описание
  type: string

# String обмежений
- name: Код
  type: string
  length: 10              # Максимум символів

# Number
- name: Сумма
  type: number
  digits: 15              # Всього цифр
  fraction_digits: 2      # Після коми

# Date
- name: ДатаНачала
  type: date

# Boolean
- name: Активен
  type: boolean
```

### Reference типи (потребують Configuration mode)
```yaml
# Довідник
- name: Контрагент
  type: CatalogRef.Контрагенты

# Документ
- name: ЗаказОснование
  type: DocumentRef.ЗаказКлиента

# Перерахування
- name: Статус
  type: EnumRef.СтатусыЗаказов
```

### Form-only типи (ТІЛЬКИ в form_attributes!)
```yaml
form_attributes:
  - name: Отчет
    type: spreadsheet_document   # Табличний документ
  - name: Файл
    type: binary_data            # Двійкові дані
  - name: HTMLКонтент
    type: string                 # ⚠️ HTML контент (для HTMLDocumentField)
```

⚠️ **HTMLDocumentField використовує `type: string`, НЕ `type: HTMLDocument`!**

---

## Елементи форми (повний довідник)

### InputField
```yaml
- type: InputField
  name: ОписаниеПоле
  attribute: Описание
  width: 40                      # Ширина в символах
  height: 5                      # Висота в рядках (multiline)
  multiline: true                # Багаторядкове
  read_only: true                # Тільки читання
  title_location: Top            # Left|Top|Right|None
  title_ru: "Опис"               # Заголовок
  input_hint: "Введіть опис"     # Placeholder
  password_mode: true            # Маскування
  horizontal_stretch: true       # Розтягування
  choice_list:                   # Dropdown варіанти
    - v: "Option1"               # v=value, ru=presentation
      ru: "Опція1"
    - v: "Option2"
      ru: "Опція2"
  events:
    OnChange: ОписаниеПриИзменении
    StartChoice: ОписаниеНачалоВыбора
    ChoiceProcessing: ОписаниеОбработкаВыбора
```

### Table
```yaml
- type: Table
  name: ТоварыТаблица
  tabular_section: Товары        # Ім'я value_table або tabular_section
  is_value_table: true           # ОБОВ'ЯЗКОВО для ValueTable!
  height: 12                     # Видимих рядків
  horizontal_stretch: true
  vertical_stretch: true
  read_only: false
  command_bar_location: Bottom   # Top|Bottom|None
  header_height: 2               # Висота заголовка
  columns:
    - name: Наименование
      attribute: Наименование
      width: 30
      read_only: false
    - name: Цена
      attribute: Цена
      width: 15
      horizontal_align: Right    # Для чисел
      format: "ЧДЦ=2"            # Формат числа
  events:
    OnActivateRow: ТоварыПриАктивизацииСтроки
    Selection: ТоварыВыбор
    BeforeAddRow: ТоварыПередДобавлениемСтроки
    BeforeDeleteRow: ТоварыПередУдалениемСтроки
    BeforeRowChange: ТоварыПередИзменениемСтроки
    AfterDeleteRow: ТоварыПослеУдаленияСтроки
```

### UsualGroup
```yaml
- type: UsualGroup
  name: ФильтрыГруппа
  title_ru: "Фільтри"
  title_uk: "Фільтри"
  show_title: true
  group_direction: Horizontal    # Vertical|Horizontal
  representation: NormalSeparation  # None|WeakSeparation|NormalSeparation|StrongSeparation
  behavior: Collapsible          # Usual|Collapsible
  collapsed: false               # Початковий стан
  horizontal_stretch: true
  child_items:
    - type: InputField
      attribute: ФильтрДата
    - type: Button
      command: Применить
```

### Pages (вкладки)
```yaml
- type: Pages
  name: ОсновныеСтраницы
  pages_representation: TabsOnTop  # TabsOnTop|TabsOnBottom|None
  horizontal_stretch: true
  vertical_stretch: true
  pages:
    - name: СтраницаДанные
      title_ru: "Дані"
      title_uk: "Дані"
      child_items:
        - type: InputField
          attribute: Поле1
        - type: InputField
          attribute: Поле2
    - name: СтраницаНастройки
      title_ru: "Налаштування"
      picture: StdPicture.CustomizeForm
      child_items:
        - type: InputField
          attribute: Настройка1
```

### LabelDecoration
```yaml
- type: LabelDecoration
  name: ЗаголовокСекции
  title_ru: "Основні дані"
  title_uk: "Основні дані"
  font:
    bold: true
    italic: false
    size: 12                     # Розмір шрифту
    face_name: Arial             # Шрифт (опційно)
  horizontal_align: Center       # Left|Center|Right
  hyperlink: true                # Як посилання
  events:
    OnClick: ЗаголовокПриКлике
```

### Button
```yaml
- type: Button
  name: ВыполнитьКнопка
  command: Выполнить             # Посилання на command
  width: 15
  height: 2
  default_button: true           # Кнопка за замовчуванням (Enter)
  representation: PictureAndText # Auto|Picture|Text|PictureAndText
```

### CheckBoxField
```yaml
- type: CheckBoxField
  name: АктивенФлаг
  attribute: Активен
  title_ru: "Активний"
  title_location: Right          # Зазвичай Right для checkbox
  events:
    OnChange: АктивенПриИзменении
```

### RadioButtonField
```yaml
- type: RadioButtonField
  name: ВыборРежима
  attribute: Режим
  title_ru: "Режим роботи"
  radio_button_type: Tumbler     # RadioButton|Tumbler
  choice_list:
    - v: "Mode1"
      ru: "Режим 1"
    - v: "Mode2"
      ru: "Режим 2"
```

### PictureDecoration
```yaml
# Стандартна іконка
- type: PictureDecoration
  name: ИконкаИнфо
  picture: StdPicture.Information
  width: 3
  height: 3

# SVG файл (конвертується в PNG)
- type: PictureDecoration
  name: ЛоготипКомпании
  svg_source: logo.svg           # Шлях до SVG
  svg_width: 200                 # Розмір PNG в пікселях
  svg_height: 80
  form_width: 25                 # Розмір на формі в символах
  form_height: 10
  picture_size: Proportionally   # AutoSize|RealSize|Proportionally|Stretch|Tile
```

### SpreadsheetDocumentField
```yaml
- type: SpreadsheetDocumentField
  name: ОтчетПоле
  attribute: ОтчетТабличный      # Має бути в form_attributes!
  horizontal_stretch: true
  vertical_stretch: true
  height: 20
```

### HTMLDocumentField

⚠️ **КРИТИЧНО:** Атрибут для HTMLDocumentField = `type: string`, НЕ `HTMLDocument`!

```yaml
# Спочатку визначаємо form_attribute
form_attributes:
  - name: HTMLКонтент
    type: string                 # ✅ ПРАВИЛЬНО! НЕ HTMLDocument!

# Потім створюємо елемент
elements:
  - type: HTMLDocumentField
    name: HTMLПоле
    attribute: HTMLКонтент       # Посилання на form_attribute
    horizontal_stretch: true
    height: 15
    events:
      OnClick: HTMLПриКлике
      DocumentComplete: HTMLДокументСформирован
```

```bsl
// Встановлення HTML контенту - просто присвоюємо рядок
HTMLКонтент = "<html><body>Hello!</body></html>";
```

---

## Commands (повний формат)

```yaml
commands:
  - name: Выполнить
    title_ru: "Виконати"
    title_uk: "Виконати"
    title_en: "Execute"
    handler: ВыполнитьОбработку   # НЕ зарезервоване слово!
    picture: StdPicture.ExecuteTask
    shortcut: F5                  # Гаряча клавіша
    tooltip_ru: "Запустити обробку"
    representation: PictureAndText
    default_button: true          # Активується на Enter
```

---

## StdPicture (повний список найчастіших)

### Дії
| Дія | StdPicture | Коли використовувати |
|-----|------------|---------------------|
| Виконати | `ExecuteTask` | Головна дія, запуск |
| Зберегти | `Write` | Збереження даних |
| Зберегти файл | `SaveFile` | Експорт у файл |
| Відкрити файл | `OpenFile` | Імпорт з файлу |
| Оновити | `Refresh` | Перезавантаження даних |
| Закрити | `Close` | Закриття форми |
| Скасувати | `Stop` | Скасування операції |

### Редагування
| Дія | StdPicture |
|-----|------------|
| Додати | `CreateListItem` |
| Видалити | `Delete` |
| Редагувати | `Change` |
| Копіювати | `CloneListItem` |
| Позначити на видалення | `MarkToDelete` |

### Навігація
| Дія | StdPicture |
|-----|------------|
| Пошук | `Find` |
| Вгору | `MoveUp` |
| Вниз | `MoveDown` |
| Розгорнути все | `ExpandAll` |
| Згорнути все | `CollapseAll` |
| Назад | `Back` |
| Вперед | `Forward` |

### Звіти та друк
| Дія | StdPicture |
|-----|------------|
| Сформувати звіт | `GenerateReport` |
| Друк | `Print` |
| Друк без перегляду | `PrintImmediately` |
| Налаштування звіту | `ReportSettings` |

### Інше
| Дія | StdPicture |
|-----|------------|
| Налаштування | `CustomizeForm` |
| Інформація | `Information` |
| Попередження | `Warning` |
| Помилка | `Error` |
| Питання | `Question` |
| Користувач | `User` |
| Властивості | `Properties` |
| Допомога | `Help` |
| Провести | `Post` |
| Скасувати проведення | `UndoPosting` |

---

## Shortcuts (гарячі клавіші)

| Клавіша | Типове використання |
|---------|---------------------|
| `F5` | Виконати / Оновити |
| `F1` | Допомога |
| `Ctrl+S` | Зберегти |
| `Ctrl+N` | Створити |
| `Ctrl+F` | Пошук |
| `Ctrl+P` | Друк |
| `Delete` | Видалити |
| `Insert` | Додати |
| `Escape` | Закрити / Скасувати |

---

## BSL Patterns

### Client-Server (базовий)
```bsl
&НаКлиенте
Процедура ВыполнитьОбработку(Команда)
    Если НЕ ЗначениеЗаполнено(Объект.Поле) Тогда
        Сообщить("Заповніть поле!");
        Возврат;
    КонецЕсли;
    ВыполнитьОбработкуНаСервере();
КонецПроцедуры

&НаСервере
Процедура ВыполнитьОбработкуНаСервере()
    // Робота з БД, файлами
КонецПроцедуры
```

### OnCreateAtServer (ініціалізація)
```bsl
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
    // Встановлення значень за замовчуванням
    Объект.ДатаНачала = НачалоДня(ТекущаяДата());
    Объект.ДатаОкончания = КонецДня(ТекущаяДата());

    // Завантаження початкових даних
    ЗагрузитьСписокОрганизаций();
КонецПроцедуры
```

### OnActivateRow (Master-Detail)
```bsl
&НаКлиенте
Процедура ГлавнаяТаблицаПриАктивизацииСтроки(Элемент)
    ТекущиеДанные = Элементы.ГлавнаяТаблица.ТекущиеДанные;
    Если ТекущиеДанные = Неопределено Тогда
        Возврат;
    КонецЕсли;
    ОбновитьДетализациюНаСервере(ТекущиеДанные.Идентификатор);
КонецПроцедуры

&НаСервере
Процедура ОбновитьДетализациюНаСервере(ИдентификаторМастера)
    ДетальнаяТаблица.Очистить();

    Если НЕ ЗначениеЗаполнено(ИдентификаторМастера) Тогда
        Возврат;
    КонецЕсли;

    Запрос = Новый Запрос;
    Запрос.Текст = "ВЫБРАТЬ * ИЗ Таблица ГДЕ Родитель = &Родитель";
    Запрос.УстановитьПараметр("Родитель", ИдентификаторМастера);

    Выборка = Запрос.Выполнить().Выбрать();
    Пока Выборка.Следующий() Цикл
        НоваяСтрока = ДетальнаяТаблица.Добавить();
        ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
    КонецЦикла;
КонецПроцедуры
```

### Query Pattern (запит до БД)
```bsl
&НаСервере
Процедура ЗагрузитьДанныеНаСервере()
    Результаты.Очистить();

    Запрос = Новый Запрос;
    Запрос.Текст = "
    |ВЫБРАТЬ
    |    Товары.Наименование КАК Наименование,
    |    Товары.Цена КАК Цена,
    |    Товары.Остаток КАК Остаток
    |ИЗ
    |    Справочник.Товары КАК Товары
    |ГДЕ
    |    НЕ Товары.ПометкаУдаления
    |    И Товары.Наименование ПОДОБНО &Фильтр
    |УПОРЯДОЧИТЬ ПО
    |    Наименование";

    Запрос.УстановитьПараметр("Фильтр", "%" + Объект.ФильтрПоиска + "%");

    Выборка = Запрос.Выполнить().Выбрать();
    Пока Выборка.Следующий() Цикл
        НоваяСтрока = Результаты.Добавить();
        ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
    КонецЦикла;
КонецПроцедуры
```

### Try-Catch (обробка помилок)
```bsl
&НаСервере
Процедура ВыполнитьРискованнуюОперациюНаСервере()
    Попытка
        // Ризикована операція
        Результат = ВыполнитьВнешнийЗапрос();
        Объект.Результат = Результат;
    Исключение
        ИнформацияОбОшибке = ОписаниеОшибки();
        ЗаписьЖурналаРегистрации("Ошибка", УровеньЖурналаРегистрации.Ошибка, , ,
            "Помилка виконання: " + ИнформацияОбОшибке);
        ВызватьИсключение "Помилка: " + ИнформацияОбОшибке;
    КонецПопытки;
КонецПроцедуры
```

### BeforeAddRow (валідація перед додаванням)
```bsl
&НаКлиенте
Процедура ТоварыПередДобавлениемСтроки(Элемент, Отказ, Копирование, Родитель, Группа)
    // Перевірка ліміту рядків
    Если Товары.Количество() >= 100 Тогда
        Сообщить("Максимум 100 рядків!");
        Отказ = Истина;
        Возврат;
    КонецЕсли;
КонецПроцедуры
```

### BeforeDeleteRow (підтвердження видалення)
```bsl
&НаКлиенте
Процедура ТоварыПередУдалениемСтроки(Элемент, Отказ)
    ТекущиеДанные = Элементы.Товары.ТекущиеДанные;
    Если ТекущиеДанные = Неопределено Тогда
        Возврат;
    КонецЕсли;

    Ответ = Вопрос("Видалити рядок?", РежимДиалогаВопрос.ДаНет);
    Если Ответ = КодВозвратаДиалога.Нет Тогда
        Отказ = Истина;
    КонецЕсли;
КонецПроцедуры
```

### File Operations (робота з файлами)
```bsl
&НаКлиенте
Процедура СохранитьВФайл(Команда)
    Диалог = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Сохранение);
    Диалог.Фильтр = "Excel файлы (*.xlsx)|*.xlsx";
    Диалог.Заголовок = "Зберегти як";

    Если Диалог.Выбрать() Тогда
        СохранитьВФайлНаСервере(Диалог.ПолноеИмяФайла);
        Сообщить("Файл збережено: " + Диалог.ПолноеИмяФайла);
    КонецЕсли;
КонецПроцедуры
```

---

## Form Events

| Event | Директива | Опис |
|-------|-----------|------|
| `OnCreateAtServer` | `&НаСервере` | Ініціалізація форми на сервері |
| `OnOpen` | `&НаКлиенте` | Після відкриття форми |
| `OnClose` | `&НаКлиенте` | Перед закриттям форми |
| `BeforeWrite` | `&НаКлиенте` | Перед записом об'єкта |
| `AfterWrite` | `&НаКлиенте` | Після запису об'єкта |
| `OnChange` | `&НаКлиенте` | Зміна значення поля |
| `OnActivateRow` | `&НаКлиенте` | Активація рядка таблиці |
| `Selection` | `&НаКлиенте` | Подвійний клік на рядку |

---

## BSP Integration (детально)

### BSP Types
| Type YAML | Тип 1С | Опис | Приклад |
|-----------|--------|------|---------|
| `object_filling` | ЗаполнениеОбъекта | Заповнення ТЧ документа | Заповнити товари по залишках |
| `print_form` | ПечатнаяФорма | Зовнішня друкована форма | Рахунок-фактура |
| `additional_processor` | ДополнительнаяОбработка | Глобальна обробка | Масове оновлення цін |
| `additional_report` | ДополнительныйОтчет | Глобальний звіт | Звіт по продажах |
| `creation_of_related` | СозданиеСвязанныхОбъектов | Створення пов'язаних | Створити рахунок з замовлення |

### BSP Usage Types
| Usage YAML | Тип 1С | Потрібна форма? | Опис |
|------------|--------|-----------------|------|
| `client_method` | ВызовКлиентскогоМетода | **ТАК** | Виклик з клієнта |
| `server_method` | ВызовСерверногоМетода | НІ | Виклик з сервера |
| `open_form` | ОткрытиеФормы | **ТАК** | Відкрити форму обробки |

### Приклад: Object Filling
```yaml
processor:
  name: ЗаполнениеТоваров
  synonym_ru: Заполнение товаров
  synonym_uk: Заповнення товарів

bsp:
  type: object_filling
  version: "1.0"
  safe_mode: false
  information: "Заповнює табличну частину Товари по залишках складу"
  targets:
    - Документ.РеализацияТоваров
    - Документ.ПеремещениеТоваров
  commands:
    - id: ЗаполнитьТовары
      title:
        ru: Заполнить товарами
        uk: Заповнити товарами
      usage: client_method

forms:
  - name: Форма
    default: true
    elements:
      - type: LabelDecoration
        name: Инструкция
        title_ru: "Натисніть кнопку для заповнення"
```

```bsl
// handlers.bsl
&НаКлиенте
Процедура ЗаполнитьТовары(ДокументОбъект) Экспорт
    Если ДокументОбъект = Неопределено Тогда
        Сообщить("Обробка повинна бути викликана з документа.");
        Возврат;
    КонецЕсли;
    ЗаполнитьТоварыНаСервере(ДокументОбъект);
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьТоварыНаСервере(ДокументОбъект)
    Склад = Неопределено;

    Если ТипЗнч(ДокументОбъект) = Тип("ДокументОбъект.РеализацияТоваров") Тогда
        Склад = ДокументОбъект.Склад;
    ИначеЕсли ТипЗнч(ДокументОбъект) = Тип("ДокументОбъект.ПеремещениеТоваров") Тогда
        Склад = ДокументОбъект.СкладОтправитель;
    Иначе
        Возврат;
    КонецЕсли;

    Если НЕ ЗначениеЗаполнено(Склад) Тогда
        Возврат;
    КонецЕсли;

    ДокументОбъект.Товары.Очистить();

    Запрос = Новый Запрос;
    Запрос.Текст = "
    |ВЫБРАТЬ
    |    Остатки.Номенклатура,
    |    Остатки.КоличествоОстаток КАК Количество
    |ИЗ
    |    РегистрНакопления.ТоварыНаСкладах.Остатки(, Склад = &Склад) КАК Остатки
    |ГДЕ
    |    Остатки.КоличествоОстаток > 0";

    Запрос.УстановитьПараметр("Склад", Склад);

    Выборка = Запрос.Выполнить().Выбрать();
    Пока Выборка.Следующий() Цикл
        Строка = ДокументОбъект.Товары.Добавить();
        Строка.Номенклатура = Выборка.Номенклатура;
        Строка.Количество = Выборка.Количество;
    КонецЦикла;
КонецПроцедуры
```

**⚠️ НІКОЛИ не пиши `СведенияОВнешнейОбработке()` вручну! Генератор створює автоматично.**

---

## ObjectModule (експортні процедури)

```yaml
processor:
  name: КалькуляторСумм
  synonym_ru: Калькулятор сумм

object_module:
  file: object_module.bsl
```

**object_module.bsl:**
```bsl
#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

// Розрахунок суми з ПДВ
// Параметри:
//   Сумма - Число - сума без ПДВ
//   СтавкаПДВ - Число - ставка ПДВ (20 = 20%)
// Повертає:
//   Число - сума з ПДВ
Функция РассчитатьСуммуСПДВ(Сумма, СтавкаПДВ = 20) Экспорт
    Возврат Сумма * (1 + СтавкаПДВ / 100);
КонецФункции

// Отримати дані для звіту
Функция ПолучитьДанныеОтчета(ДатаНачала, ДатаОкончания) Экспорт
    Запрос = Новый Запрос;
    Запрос.Текст = "ВЫБРАТЬ * ИЗ Таблица ГДЕ Дата МЕЖДУ &Начало И &Конец";
    Запрос.УстановитьПараметр("Начало", ДатаНачала);
    Запрос.УстановитьПараметр("Конец", ДатаОкончания);
    Возврат Запрос.Выполнить().Выгрузить();
КонецФункции

#КонецОбласти

#Иначе
    ВызватьИсключение "Недопустимый вызов объекта на клиенте.";
#КонецЕсли
```

### Альтернатива: Регіон #Область МодульОбъекта (v2.66.0+)

Замість окремого файлу `object_module.bsl`, можна писати код ObjectModule прямо в `handlers.bsl`:

```bsl
// handlers.bsl

#Область МодульОбъекта

// Цей код потрапить в ObjectModule.bsl
Функция СведенияОВнешнейОбработке() Экспорт
    ПараметрыРегистрации = Новый Структура;
    ПараметрыРегистрации.Вставить("Вид", "ЗаполнениеОбъекта");
    // ...
    Возврат ПараметрыРегистрации;
КонецФункции

Функция МояЭкспортнаяФункция() Экспорт
    // Бізнес-логіка
    Возврат Результат;
КонецФункции

#КонецОбласти

// Далі звичайні handlers для форми
&НаКлиенте
Процедура Команда1(Команда)
    // Цей код потрапить в FormModule
КонецПроцедуры
```

**Особливості:**
- Код автоматично обгортається в `#Если Сервер...`
- Підтримує назви: `МодульОбъекта`, `МодульОб'єкта`, `ObjectModule`
- Можна комбінувати з `bsp:` секцією (код об'єднується)

---

## Form Properties

```yaml
forms:
  - name: НастройкиФорма
    default: false
    properties:
      WindowOpeningMode: LockOwnerWindow     # Independent|LockOwnerWindow|LockWholeInterface
      CommandBarLocation: Bottom             # Top|Bottom|None
      AutoTitle: false
      Title: "Налаштування"
      SaveValuesOnClose: true                # Зберігати значення при закритті
```

---

## Приклад 1: Simple Form (калькулятор)

```yaml
processor:
  name: КалькуляторНДС
  synonym_ru: Калькулятор НДС
  synonym_uk: Калькулятор ПДВ

attributes:
  - name: СуммаБезНДС
    type: number
    digits: 15
    fraction_digits: 2
  - name: СтавкаНДС
    type: number
    digits: 5
    fraction_digits: 2
  - name: СуммаНДС
    type: number
    digits: 15
    fraction_digits: 2
  - name: СуммаСНДС
    type: number
    digits: 15
    fraction_digits: 2

forms:
  - name: Форма
    default: true
    events:
      OnCreateAtServer: ПриСозданииНаСервере
    elements:
      - type: UsualGroup
        name: ВводГруппа
        group_direction: Vertical
        child_items:
          - type: InputField
            name: СуммаБезНДСПоле
            attribute: СуммаБезНДС
            title_ru: "Сума без ПДВ"
            width: 15
          - type: InputField
            name: СтавкаНДСПоле
            attribute: СтавкаНДС
            title_ru: "Ставка ПДВ %"
            width: 10
      - type: UsualGroup
        name: РезультатГруппа
        title_ru: "Результат"
        representation: NormalSeparation
        child_items:
          - type: InputField
            name: СуммаНДСПоле
            attribute: СуммаНДС
            title_ru: "Сума ПДВ"
            read_only: true
            width: 15
          - type: InputField
            name: СуммаСНДСПоле
            attribute: СуммаСНДС
            title_ru: "Сума з ПДВ"
            read_only: true
            width: 15
      - type: Button
        name: РассчитатьКнопка
        command: Рассчитать
        width: 15
    commands:
      - name: Рассчитать
        title_ru: Розрахувати
        title_uk: Розрахувати
        handler: РассчитатьСумму
        picture: StdPicture.ExecuteTask
        shortcut: F5
```

```bsl
// handlers.bsl
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
    Объект.СтавкаНДС = 20;
КонецПроцедуры

&НаКлиенте
Процедура РассчитатьСумму(Команда)
    Если НЕ ЗначениеЗаполнено(Объект.СуммаБезНДС) Тогда
        Сообщить("Введіть суму!");
        Возврат;
    КонецЕсли;

    Если НЕ ЗначениеЗаполнено(Объект.СтавкаНДС) Тогда
        Объект.СтавкаНДС = 20;
    КонецЕсли;

    Объект.СуммаНДС = Объект.СуммаБезНДС * Объект.СтавкаНДС / 100;
    Объект.СуммаСНДС = Объект.СуммаБезНДС + Объект.СуммаНДС;
КонецПроцедуры
```

---

## Приклад 2: Report with Table

```yaml
processor:
  name: ОтчетПоТоварам
  synonym_ru: Отчет по товарам
  synonym_uk: Звіт по товарах

attributes:
  - name: ДатаНачала
    type: date
  - name: ДатаОкончания
    type: date
  - name: ФильтрКатегория
    type: string
    length: 100

forms:
  - name: Форма
    default: true
    events:
      OnCreateAtServer: ПриСозданииНаСервере
    value_tables:
      - name: Результаты
        columns:
          - {name: Товар, type: string, length: 150}
          - {name: Категория, type: string, length: 100}
          - {name: Количество, type: number, digits: 10}
          - {name: Сумма, type: number, digits: 15, fraction_digits: 2}
    elements:
      - type: UsualGroup
        name: ФильтрыГруппа
        title_ru: "Фільтри"
        group_direction: Horizontal
        representation: WeakSeparation
        child_items:
          - type: InputField
            name: ДатаНачалаПоле
            attribute: ДатаНачала
            title_ru: "Дата з"
            width: 12
          - type: InputField
            name: ДатаОкончанияПоле
            attribute: ДатаОкончания
            title_ru: "Дата по"
            width: 12
          - type: InputField
            name: КатегорияПоле
            attribute: ФильтрКатегория
            title_ru: "Категорія"
            width: 20
          - type: Button
            name: СформироватьКнопка
            command: Сформировать
      - type: Table
        name: РезультатыТаблица
        tabular_section: Результаты
        is_value_table: true
        height: 15
        horizontal_stretch: true
        command_bar_location: Bottom
        columns:
          - name: ТоварКолонка
            attribute: Товар
            width: 30
          - name: КатегорияКолонка
            attribute: Категория
            width: 20
          - name: КоличествоКолонка
            attribute: Количество
            width: 10
            horizontal_align: Right
          - name: СуммаКолонка
            attribute: Сумма
            width: 15
            horizontal_align: Right
    commands:
      - name: Сформировать
        title_ru: Сформувати
        title_uk: Сформувати
        handler: СформироватьОтчет
        picture: StdPicture.GenerateReport
        shortcut: F5
      - name: Экспорт
        title_ru: Експорт
        handler: ЭкспортироватьВExcel
        picture: StdPicture.SaveFile
```

```bsl
// handlers.bsl
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
    Объект.ДатаНачала = НачалоМесяца(ТекущаяДата());
    Объект.ДатаОкончания = КонецМесяца(ТекущаяДата());
КонецПроцедуры

&НаКлиенте
Процедура СформироватьОтчет(Команда)
    Если НЕ ЗначениеЗаполнено(Объект.ДатаНачала) Тогда
        Сообщить("Вкажіть дату початку!");
        Возврат;
    КонецЕсли;
    СформироватьОтчетНаСервере();
    Сообщить("Знайдено записів: " + Результаты.Количество());
КонецПроцедуры

&НаСервере
Процедура СформироватьОтчетНаСервере()
    Результаты.Очистить();

    Запрос = Новый Запрос;
    Запрос.Текст = "
    |ВЫБРАТЬ
    |    Товары.Наименование КАК Товар,
    |    Товары.Категория.Наименование КАК Категория,
    |    СУММА(Продажи.Количество) КАК Количество,
    |    СУММА(Продажи.Сумма) КАК Сумма
    |ИЗ
    |    Документ.Продажа.Товары КАК Продажи
    |    ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Товары КАК Товары
    |        ПО Продажи.Товар = Товары.Ссылка
    |ГДЕ
    |    Продажи.Ссылка.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
    |    И Товары.Наименование ПОДОБНО &Фильтр
    |СГРУППИРОВАТЬ ПО
    |    Товары.Наименование,
    |    Товары.Категория.Наименование
    |УПОРЯДОЧИТЬ ПО
    |    Сумма УБЫВ";

    Запрос.УстановитьПараметр("ДатаНачала", НачалоДня(Объект.ДатаНачала));
    Запрос.УстановитьПараметр("ДатаОкончания", КонецДня(Объект.ДатаОкончания));
    Запрос.УстановитьПараметр("Фильтр", "%" + Объект.ФильтрКатегория + "%");

    Выборка = Запрос.Выполнить().Выбрать();
    Пока Выборка.Следующий() Цикл
        НоваяСтрока = Результаты.Добавить();
        ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
    КонецЦикла;
КонецПроцедуры

&НаКлиенте
Процедура ЭкспортироватьВExcel(Команда)
    Если Результаты.Количество() = 0 Тогда
        Сообщить("Немає даних для експорту!");
        Возврат;
    КонецЕсли;
    Сообщить("Експорт виконано (реалізуйте збереження у файл)");
КонецПроцедуры
```

---

## Приклад 3: Master-Detail

```yaml
processor:
  name: ПросмотрЗаказов
  synonym_ru: Просмотр заказов
  synonym_uk: Перегляд замовлень

forms:
  - name: Форма
    default: true
    value_tables:
      - name: Заказы
        columns:
          - {name: Номер, type: string, length: 20}
          - {name: Дата, type: date}
          - {name: Контрагент, type: string, length: 150}
          - {name: Сумма, type: number, digits: 15, fraction_digits: 2}
      - name: Товары
        columns:
          - {name: Товар, type: string, length: 150}
          - {name: Количество, type: number, digits: 10}
          - {name: Цена, type: number, digits: 15, fraction_digits: 2}
          - {name: Сумма, type: number, digits: 15, fraction_digits: 2}
    elements:
      - type: UsualGroup
        name: ГлавнаяГруппа
        group_direction: Vertical
        child_items:
          - type: Table
            name: ЗаказыТаблица
            tabular_section: Заказы
            is_value_table: true
            height: 8
            horizontal_stretch: true
            events:
              OnActivateRow: ЗаказыПриАктивизацииСтроки
          - type: LabelDecoration
            name: ТоварыЗаголовок
            title_ru: "Товари замовлення"
            font:
              bold: true
          - type: Table
            name: ТоварыТаблица
            tabular_section: Товары
            is_value_table: true
            height: 10
            horizontal_stretch: true
            read_only: true
    commands:
      - name: Обновить
        title_ru: Оновити
        handler: ОбновитьСписок
        picture: StdPicture.Refresh
        shortcut: F5
```

```bsl
// handlers.bsl
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
    ЗагрузитьЗаказыНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьСписок(Команда)
    ЗагрузитьЗаказыНаСервере();
КонецПроцедуры

&НаСервере
Процедура ЗагрузитьЗаказыНаСервере()
    Заказы.Очистить();
    Товары.Очистить();

    Запрос = Новый Запрос;
    Запрос.Текст = "
    |ВЫБРАТЬ ПЕРВЫЕ 100
    |    Заказ.Номер КАК Номер,
    |    Заказ.Дата КАК Дата,
    |    Заказ.Контрагент.Наименование КАК Контрагент,
    |    Заказ.СуммаДокумента КАК Сумма,
    |    Заказ.Ссылка КАК Ссылка
    |ИЗ
    |    Документ.ЗаказКлиента КАК Заказ
    |УПОРЯДОЧИТЬ ПО
    |    Дата УБЫВ";

    Выборка = Запрос.Выполнить().Выбрать();
    Пока Выборка.Следующий() Цикл
        НоваяСтрока = Заказы.Добавить();
        ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
    КонецЦикла;
КонецПроцедуры

&НаКлиенте
Процедура ЗаказыПриАктивизацииСтроки(Элемент)
    ТекущиеДанные = Элементы.ЗаказыТаблица.ТекущиеДанные;
    Если ТекущиеДанные = Неопределено Тогда
        Товары.Очистить();
        Возврат;
    КонецЕсли;
    ЗагрузитьТоварыНаСервере(ТекущиеДанные.Номер);
КонецПроцедуры

&НаСервере
Процедура ЗагрузитьТоварыНаСервере(НомерЗаказа)
    Товары.Очистить();

    Запрос = Новый Запрос;
    Запрос.Текст = "
    |ВЫБРАТЬ
    |    Товары.Номенклатура.Наименование КАК Товар,
    |    Товары.Количество КАК Количество,
    |    Товары.Цена КАК Цена,
    |    Товары.Сумма КАК Сумма
    |ИЗ
    |    Документ.ЗаказКлиента.Товары КАК Товары
    |ГДЕ
    |    Товары.Ссылка.Номер = &Номер";

    Запрос.УстановитьПараметр("Номер", НомерЗаказа);

    Выборка = Запрос.Выполнить().Выбрать();
    Пока Выборка.Следующий() Цикл
        НоваяСтрока = Товары.Добавить();
        ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
    КонецЦикла;
КонецПроцедуры
```

---

## Thin Client обмеження

### Тільки &НаСервере
| Операція | Чому |
|----------|------|
| `SpreadsheetDocument.Очистить()` | Метод недоступен на thin client |
| `SpreadsheetDocument.Область()` | Метод недоступен на thin client |
| `ДиалогВыбораФайла` | Сервер має доступ до ФС |
| `Запрос` | Прямі запити до БД |
| Файлові операції | Сервер має доступ до ФС |

### Доступно на &НаКлиенте
| Операція | Примітка |
|----------|----------|
| `Сообщить()` | Повідомлення користувачу |
| `Вопрос()` | Діалог вибору |
| `ПодключитьОбработчикОжидания()` | Таймери та асинхронні виклики |
| `ОтключитьОбработчикОжидания()` | Зупинка таймера |
| Доступ до `Элементы.*` | UI маніпуляції |
| Читання/запис `form_attributes` | SpreadsheetDocument, BinaryData |

### SpreadsheetDocument правильний патерн
```bsl
&НаКлиенте
Процедура ОновитиДокумент(Команда)
    // Виклик серверної процедури
    ОновитиДокументНаСервере();
КонецПроцедуры

&НаСервере
Процедура ОновитиДокументНаСервере()
    // ВСЯ маніпуляція тут!
    ТабДок.Очистить();
    Область = ТабДок.Область(1, 1);
    Область.Текст = "Значення";
КонецПроцедуры
```

---

## Таймери та асинхронні виклики

**ЄДИНИЙ спосіб створити таймер в EPF:**

```bsl
&НаКлиенте
Процедура СтартТаймера(Команда)
    // Одноразовий виклик через 0.5 сек
    ПодключитьОбработчикОжидания("МояПроцедура", 0.5, Истина);

    // Повторюваний виклик кожні 0.5 сек
    ПодключитьОбработчикОжидания("МояПроцедура", 0.5, Ложь);
КонецПроцедуры

&НаКлиенте
Процедура СтопТаймера(Команда)
    ОтключитьОбработчикОжидания("МояПроцедура");
КонецПроцедуры

&НаКлиенте
Процедура МояПроцедура()
    // Код що виконується по таймеру
КонецПроцедуры
```

**Параметри:**
- `ИмяПроцедуры` — рядок з ім'ям процедури (в лапках!)
- `Интервал` — секунди (можна дробні: 0.5, 0.1)
- `Однократно` — `Истина` (один раз) або `Ложь` (повторювано)

---

## patchSessionCode Action (часткові зміни)

Застосовує часткові зміни до YAML/BSL без повної заміни коду.

### YAML Patches (JSON Pointer paths)

```json
{
  "yaml_patches": [
    {"op": "add", "path": "/forms/0/commands/-", "value": {"name": "MoveUp", "handler": "ВгоруНатиснуто", "shortcut": "F5"}},
    {"op": "replace", "path": "/forms/0/form_attributes/0/type", "value": "string"},
    {"op": "add", "path": "/forms/0/commands/-", "value": {"name": "Pause", "handler": "ПаузаИгры"}},
    {"op": "remove", "path": "/forms/0/elements/2"},
    {"op": "merge", "path": "/processor", "value": {"synonym_uk": "Нова назва"}}
  ]
}
```

| op | Опис |
|----|------|
| `add` | Додати секцію/елемент. `-` в path = append до масиву |
| `replace` | Замінити існуюче значення |
| `remove` | Видалити елемент |
| `merge` | Злити з існуючим об'єктом (не перезаписує все) |

### BSL Patches (procedure-level)

```json
{
  "bsl_patches": [
    {
      "op": "add_procedure",
      "name": "ВгоруНатиснуто",
      "directive": "&НаКлиенте",
      "body": "Направление = \"Вверх\";"
    },
    {
      "op": "replace_line",
      "procedure": "НачатьИгру",
      "line_pattern": "ПодключитьОбработчикОжидания.*0\\.3",
      "new_line": "ПодключитьОбработчикОжидания(\"ВыполнитьШаг\", 1);"
    },
    {
      "op": "add_variable",
      "directive": "&НаКлиенте",
      "names": ["НоваяЗмінна", "ІншаЗмінна"]
    },
    {
      "op": "remove_procedure",
      "name": "СтараПроцедура"
    }
  ]
}
```

| op | Опис |
|----|------|
| `add_procedure` | Додати нову процедуру. `params` опційний |
| `replace_line` | Замінити рядок за regex патерном в процедурі |
| `add_variable` | Додати `Перем` з директивою |
| `remove_procedure` | Видалити процедуру повністю |

### Коли використовувати patchSessionCode

- ✅ Додати нову подію (OnActivateRow) або команду з shortcut
- ✅ Виправити параметр (інтервал таймера, тип атрибуту)
- ✅ Додати нову команду або процедуру
- ✅ Замінити конкретний рядок коду
- ❌ Великі зміни структури → краще submitSessionCode

---

## Checklist перед генерацією

### Ідентифікатори
- [ ] Без українських літер `і ї є ґ` (тільки російська кирилиця)
- [ ] Handler НЕ є зарезервованим словом BSL
- [ ] Немає пробілів та спецсимволів в іменах

### Структура YAML
- [ ] `default: true` на головній формі
- [ ] `is_value_table: true` для всіх Table з ValueTable
- [ ] `SpreadsheetDocument`, `BinaryData`, `HTMLDocument` в `form_attributes:` (не в `attributes:`)
- [ ] `form_attributes:` всередині `forms:` секції (не на root level)

### Зв'язки
- [ ] Всі `attribute:` в елементах існують в `attributes:` або `form_attributes:`
- [ ] Всі `command:` в Button існують в `commands:`
- [ ] Всі `tabular_section:` існують в `value_tables:`
- [ ] Всі `handler:` мають процедури в handlers.bsl

### BSL
- [ ] `&НаСервере` для серверного коду
- [ ] `&НаКлиенте` для клієнтського коду
- [ ] Правильні сигнатури подій (OnCreateAtServer має параметри!)
- [ ] Client-server пари для запитів до БД

### BSP
- [ ] НЕ писати `СведенияОВнешнейОбработке()` вручну
- [ ] `client_method` / `open_form` мають форму
- [ ] `targets:` містить правильні metadata paths
