// Server-side report generation
// Серверна генерація звіту з агрегацією даних

// Clear previous results
Результаты.Очистить();

// Build query to aggregate sales by month
Запрос = Новый Запрос;
Запрос.Текст = "
	|ВЫБРАТЬ
	|	НАЧАЛОПЕРИОДА(РеализацияТоваровУслуг.Дата, МЕСЯЦ) КАК Период,
	|	СУММА(РеализацияТоваровУслугТовары.Количество) КАК Количество,
	|	СУММА(РеализацияТоваровУслугТовары.Сумма) КАК Сумма,
	|	СУММА(РеализацияТоваровУслугТовары.Сумма - РеализацияТоваровУслугТовары.СуммаАвтоматическойСкидки) КАК СуммаСоСкидкой
	|ИЗ
	|	Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	|		ПО РеализацияТоваровУслуг.Ссылка = РеализацияТоваровУслугТовары.Ссылка
	|ГДЕ
	|	РеализацияТоваровУслуг.Проведен
	|	И РеализацияТоваровУслуг.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
	|	" + ?(ЗначениеЗаполнено(Объект.Организация), "И РеализацияТоваровУслуг.Организация = &Организация", "") + "
	|
	|СГРУППИРОВАТЬ ПО
	|	НАЧАЛОПЕРИОДА(РеализацияТоваровУслуг.Дата, МЕСЯЦ)
	|
	|УПОРЯДОЧИТЬ ПО
	|	Период
";

// Set query parameters
Запрос.УстановитьПараметр("ДатаНачала", НачалоДня(Объект.ДатаНачала));
Запрос.УстановитьПараметр("ДатаОкончания", КонецДня(Объект.ДатаОкончания));

Если ЗначениеЗаполнено(Объект.Организация) Тогда
	Запрос.УстановитьПараметр("Организация", Объект.Организация);
КонецЕсли;

// Execute query
Попытка
	РезультатЗапроса = Запрос.Выполнить();
	Выборка = РезультатЗапроса.Выбрать();

	// Fill results table
	Пока Выборка.Следующий() Цикл
		НоваяСтрока = Результаты.Добавить();
		НоваяСтрока.Период = Выборка.Период;
		НоваяСтрока.МесяцСтрокой = Формат(Выборка.Период, "ДФ='ММММ yyyy'");
		НоваяСтрока.Количество = Выборка.Количество;
		НоваяСтрока.Сумма = Выборка.Сумма;
		НоваяСтрока.СуммаСоСкидкой = Выборка.СуммаСоСкидкой;
	КонецЦикла;

Исключение
	Сообщить("Ошибка при выполнении запроса: " + ОписаниеОшибки());
КонецПопытки;
