// ValueTree Example - BSL Handlers (v2.64.0+)
// Demonstrates hierarchical tree operations

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриОткрытииНаСервере()
    // Fill tree with sample data on form open
    ЗаполнитьДеревоПримером();
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовФормы

&НаКлиенте
Процедура ДеревоТаблицаПриАктивизацииСтроки(Элемент)
    // Update info when tree row is selected
    ТекущиеДанные = Элементы.ДеревоТаблица.ТекущиеДанные;
    Если ТекущиеДанные <> Неопределено Тогда
        Элементы.ИнформацияОВыбранном.Заголовок =
            "Выбрано: " + ТекущиеДанные.Наименование +
            " (" + ТекущиеДанные.Тип + ")";
    КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ДеревоТаблицаВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
    // Handle double-click on tree item
    ТекущиеДанные = Элементы.ДеревоТаблица.ТекущиеДанные;
    Если ТекущиеДанные <> Неопределено Тогда
        Если ТекущиеДанные.Тип = "Значение" Тогда
            ПоказатьПредупреждение(, "Значение: " + ТекущиеДанные.Значение);
        КонецЕсли;
    КонецЕсли;
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКоманд

&НаКлиенте
Процедура Обновить(Команда)
    ОбновитьНаСервере();
КонецПроцедуры

&НаСервере
Процедура ОбновитьНаСервере()
    ЗаполнитьДеревоПримером();
КонецПроцедуры

&НаКлиенте
Процедура ЗагрузитьJSON(Команда)
    // Demonstrate loading JSON into tree
    ДиалогВыбора = Новый ДиалогВыбораФайла(РежимДиалогаВыбораФайла.Открытие);
    ДиалогВыбора.Фильтр = "JSON файлы (*.json)|*.json";
    ДиалогВыбора.Заголовок = "Выберите JSON файл";

    Если ДиалогВыбора.Выбрать() Тогда
        ЗагрузитьJSONФайлНаСервере(ДиалогВыбора.ПолноеИмяФайла);
    КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура ЗагрузитьJSONФайлНаСервере(ПутьКФайлу)
    // Parse JSON file and fill tree
    Попытка
        ТекстФайла = Новый ЧтениеТекста(ПутьКФайлу, КодировкаТекста.UTF8);
        СодержимоеJSON = ТекстФайла.Прочитать();
        ТекстФайла.Закрыть();

        ЧтениеJSON = Новый ЧтениеJSON;
        ЧтениеJSON.УстановитьСтроку(СодержимоеJSON);
        ДанныеJSON = ПрочитатьJSON(ЧтениеJSON);
        ЧтениеJSON.Закрыть();

        // Clear tree and fill from JSON
        ДеревоДанных.ПолучитьЭлементы().Очистить();
        ЗаполнитьДеревоИзЗначения(ДеревоДанных.ПолучитьЭлементы(), "JSON", ДанныеJSON);

    Исключение
        Сообщить("Ошибка загрузки JSON: " + ОписаниеОшибки());
    КонецПопытки;
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура ЗаполнитьДеревоПримером()
    // Clear existing data
    ДеревоДанных.ПолучитьЭлементы().Очистить();

    // Root level 1: Settings
    Настройки = ДеревоДанных.ПолучитьЭлементы().Добавить();
    Настройки.Наименование = "Настройки";
    Настройки.Тип = "Объект";
    Настройки.ЕстьПодчиненные = Истина;

    // Level 2: Database settings
    БД = Настройки.ПолучитьЭлементы().Добавить();
    БД.Наименование = "База данных";
    БД.Тип = "Объект";
    БД.ЕстьПодчиненные = Истина;

    // Level 3: Database properties
    Хост = БД.ПолучитьЭлементы().Добавить();
    Хост.Наименование = "Хост";
    Хост.Значение = "localhost";
    Хост.Тип = "Значение";

    Порт = БД.ПолучитьЭлементы().Добавить();
    Порт.Наименование = "Порт";
    Порт.Значение = "5432";
    Порт.Тип = "Значение";

    // Level 2: API settings
    API = Настройки.ПолучитьЭлементы().Добавить();
    API.Наименование = "API";
    API.Тип = "Объект";
    API.ЕстьПодчиненные = Истина;

    Токен = API.ПолучитьЭлементы().Добавить();
    Токен.Наименование = "Токен";
    Токен.Значение = "***скрыто***";
    Токен.Тип = "Значение";

    Таймаут = API.ПолучитьЭлементы().Добавить();
    Таймаут.Наименование = "Таймаут";
    Таймаут.Значение = "30";
    Таймаут.Тип = "Значение";

    // Root level 2: Users (array example)
    Пользователи = ДеревоДанных.ПолучитьЭлементы().Добавить();
    Пользователи.Наименование = "Пользователи";
    Пользователи.Тип = "Массив";
    Пользователи.ЕстьПодчиненные = Истина;

    Для Сч = 1 По 3 Цикл
        Пользователь = Пользователи.ПолучитьЭлементы().Добавить();
        Пользователь.Наименование = "[" + Сч + "]";
        Пользователь.Значение = "Пользователь " + Сч;
        Пользователь.Тип = "Значение";
    КонецЦикла;
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьДеревоИзЗначения(РодительскиеЭлементы, Ключ, Значение)
    // Recursive function to build tree from any value

    ТипЗначения = ТипЗнч(Значение);

    Если ТипЗначения = Тип("Структура") ИЛИ ТипЗначения = Тип("Соответствие") Тогда
        // Object
        Узел = РодительскиеЭлементы.Добавить();
        Узел.Наименование = Ключ;
        Узел.Тип = "Объект";
        Узел.ЕстьПодчиненные = Истина;

        Для Каждого КлючЗначение Из Значение Цикл
            ЗаполнитьДеревоИзЗначения(Узел.ПолучитьЭлементы(), КлючЗначение.Ключ, КлючЗначение.Значение);
        КонецЦикла;

    ИначеЕсли ТипЗначения = Тип("Массив") Тогда
        // Array
        Узел = РодительскиеЭлементы.Добавить();
        Узел.Наименование = Ключ;
        Узел.Тип = "Массив";
        Узел.ЕстьПодчиненные = Истина;

        Для Индекс = 0 По Значение.ВГраница() Цикл
            ЗаполнитьДеревоИзЗначения(Узел.ПолучитьЭлементы(), "[" + Индекс + "]", Значение[Индекс]);
        КонецЦикла;

    Иначе
        // Primitive value
        Узел = РодительскиеЭлементы.Добавить();
        Узел.Наименование = Ключ;
        Узел.Значение = Строка(Значение);
        Узел.Тип = "Значение";
        Узел.ЕстьПодчиненные = Ложь;

    КонецЕсли;
КонецПроцедуры

#КонецОбласти
