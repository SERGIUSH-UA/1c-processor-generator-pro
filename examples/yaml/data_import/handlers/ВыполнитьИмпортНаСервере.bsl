// Server-side import execution
// Серверне виконання імпорту

// Clear previous results
РезультатыИмпорта.Очистить();

// Get catalog manager
Попытка
	МенеджерСправочника = Справочники[Объект.Справочник];
Исключение
	ВызватьИсключение "Справочник '" + Объект.Справочник + "' не найден в конфигурации!";
КонецПопытки;

// Import statistics
ВсегоСтрок = 0;
Создано = 0;
Обновлено = 0;
Ошибок = 0;

// Process each preview row
Для Каждого СтрокаПредпросмотра Из Предпросмотр Цикл
	ВсегоСтрок = ВсегоСтрок + 1;

	Попытка
		// Find existing item by code
		СуществующийЭлемент = Неопределено;

		Если ЗначениеЗаполнено(СтрокаПредпросмотра.Код) Тогда
			Запрос = Новый Запрос;
			Запрос.Текст = "
				|ВЫБРАТЬ ПЕРВЫЕ 1
				|	Справочник.Ссылка КАК Ссылка
				|ИЗ
				|	Справочник." + Объект.Справочник + " КАК Справочник
				|ГДЕ
				|	Справочник.Код = &Код
			";
			Запрос.УстановитьПараметр("Код", СтрокаПредпросмотра.Код);

			Результат = Запрос.Выполнить();
			Если НЕ Результат.Пустой() Тогда
				Выборка = Результат.Выбрать();
				Выборка.Следующий();
				СуществующийЭлемент = Выборка.Ссылка;
			КонецЕсли;
		КонецЕсли;

		// Create or update item
		Если СуществующийЭлемент = Неопределено Тогда
			// Create new item
			НовыйЭлемент = МенеджерСправочника.СоздатьЭлемент();
			НовыйЭлемент.Код = СтрокаПредпросмотра.Код;
			НовыйЭлемент.Наименование = СтрокаПредпросмотра.Наименование;
			НовыйЭлемент.Записать();

			Создано = Создано + 1;

			// Log result
			РезультатСтроки = РезультатыИмпорта.Добавить();
			РезультатСтроки.Строка = СтрокаПредпросмотра.НомерСтроки;
			РезультатСтроки.Статус = "Создано";
			РезультатСтроки.Сообщение = "Создан: " + НовыйЭлемент.Наименование;

		ИначеЕсли Объект.ОбновлятьСуществующие Тогда
			// Update existing item
			СуществующийОбъект = СуществующийЭлемент.ПолучитьОбъект();
			СуществующийОбъект.Наименование = СтрокаПредпросмотра.Наименование;
			СуществующийОбъект.Записать();

			Обновлено = Обновлено + 1;

			// Log result
			РезультатСтроки = РезультатыИмпорта.Добавить();
			РезультатСтроки.Строка = СтрокаПредпросмотра.НомерСтроки;
			РезультатСтроки.Статус = "Обновлено";
			РезультатСтроки.Сообщение = "Обновлен: " + СуществующийОбъект.Наименование;

		Иначе
			// Skip existing item
			РезультатСтроки = РезультатыИмпорта.Добавить();
			РезультатСтроки.Строка = СтрокаПредпросмотра.НомерСтроки;
			РезультатСтроки.Статус = "Пропущено";
			РезультатСтроки.Сообщение = "Запись уже существует (код: " + СтрокаПредпросмотра.Код + ")";
		КонецЕсли;

	Исключение
		Ошибок = Ошибок + 1;

		// Log error
		РезультатСтроки = РезультатыИмпорта.Добавить();
		РезультатСтроки.Строка = СтрокаПредпросмотра.НомерСтроки;
		РезультатСтроки.Статус = "Ошибка";
		РезультатСтроки.Сообщение = ОписаниеОшибки();
	КонецПопытки;
КонецЦикла;

// Summary message
Сообщить(
	"Импорт завершен:" + Символы.ПС +
	"  Всего: " + ВсегоСтрок + Символы.ПС +
	"  Создано: " + Создано + Символы.ПС +
	"  Обновлено: " + Обновлено + Символы.ПС +
	"  Ошибок: " + Ошибок
);
