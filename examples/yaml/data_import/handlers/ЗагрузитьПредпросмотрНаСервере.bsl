// Server-side file reading and preview generation
// Серверне читання файлу та генерація попереднього перегляду

// Clear previous preview
Предпросмотр.Очистить();

// Read file into binary data
ДвоичныеДанные = Новый ДвоичныеДанные(Объект.ПутьКФайлу);

// Create text reader with specified encoding
Кодировка = ?(Объект.Кодировка = "UTF-8", КодировкаТекста.UTF8,
	?(Объект.Кодировка = "Windows-1251", КодировкаТекста.ANSI, КодировкаТекста.UTF8));

ТекстовыйДокумент = Новый ТекстовыйДокумент;
ТекстовыйДокумент.Прочитать(Объект.ПутьКФайлу, Кодировка);

// Parse CSV (load first 100 rows for preview)
МаксСтрок = 100;
НомерСтроки = 0;

Для СтрокаНомер = 1 По ТекстовыйДокумент.КоличествоСтрок() Цикл
	Если НомерСтроки >= МаксСтрок Тогда
		Прервать;
	КонецЕсли;

	Строка = ТекстовыйДокумент.ПолучитьСтроку(СтрокаНомер);

	// Skip empty lines
	Если ПустаяСтрока(СокрЛП(Строка)) Тогда
		Продолжить;
	КонецЕсли;

	// Parse CSV line (simple comma-separated parser)
	Части = СтрРазделить(Строка, ";", Ложь);

	Если Части.Количество() >= 2 Тогда
		НомерСтроки = НомерСтроки + 1;

		НоваяСтрока = Предпросмотр.Добавить();
		НоваяСтрока.НомерСтроки = НомерСтроки;

		// Column 1: Name
		Если Части.Количество() > 0 Тогда
			НоваяСтрока.Наименование = СокрЛП(Части[0]);
		КонецЕсли;

		// Column 2: Code
		Если Части.Количество() > 1 Тогда
			НоваяСтрока.Код = СокрЛП(Части[1]);
		КонецЕсли;

		// Set status for preview
		НоваяСтрока.Статус = "Готов к импорту";
	КонецЕсли;
КонецЦикла;

// Validate preview has data
Если Предпросмотр.Количество() = 0 Тогда
	ВызватьИсключение "Файл не содержит данных для импорта!";
КонецЕсли;
