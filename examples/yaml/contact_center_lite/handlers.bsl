// ContactCenterLite - Operator Schedule with PlannerField
// Demonstrates: Planner dimensions, colored items, drag-drop, selection
//
// Key Planner API patterns:
// - Планировщик.Измерения.Добавить("ИмяИзмерения", Значение)
// - Планировщик.ТекущиеПериодыОтображения.Добавить(Начало, Конец)
// - Элемент = Планировщик.Элементы.Добавить(Начало, Конец)
// - Элемент.ЗначенияИзмерений = Новый ФиксированноеСоответствие(Соответствие)
// - Элемент.Текст, Элемент.ЦветФона, Элемент.ЦветТекста, Элемент.Значение

// ============================================
// Form Events
// ============================================

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	Объект.ТекущаяДата = ТекущаяДата();

	// Load demo schedule data
	ЗагрузитьДемоРасписаниеНаСервере();

	// Initialize Planner with dimensions and items
	ИнициализироватьПланировщик();

	// Update statistics
	ОбновитьСтатистикуНаСервере();
КонецПроцедуры

// ============================================
// Calendar Events
// ============================================

&НаКлиенте
Процедура КалендарьВыбор(Элемент, ВыбраннаяДата)
	// Date selected in calendar - update current date and reload planner
	Объект.ТекущаяДата = ВыбраннаяДата;
	ОбновитьПланировщикНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура ДатаПриИзменении(Элемент)
	// Date changed via input field - reload planner
	ОбновитьПланировщикНаСервере();
КонецПроцедуры

// ============================================
// Planner Events
// ============================================

&НаКлиенте
Процедура ПланировщикВыбор(Элемент, ВыделенныеЭлементы, СтандартнаяОбработка)
	// User selected planner item(s) - show details
	Если ВыделенныеЭлементы.Количество() = 0 Тогда
		ОчиститьДеталиСмены();
		Возврат;
	КонецЕсли;

	// Get first selected item
	ВыбранныйЭлемент = ВыделенныеЭлементы[0];

	// Show details (item.Значение contains our structure)
	Если ТипЗнч(ВыбранныйЭлемент.Значение) = Тип("Структура") Тогда
		ДанныеСмены = ВыбранныйЭлемент.Значение;
		Объект.ВыбранныйОператор = ДанныеСмены.Оператор;
		Объект.ВыбранныйТипСмены = ДанныеСмены.ТипСмены;
		Объект.ВыбранноеВремя = Формат(ВыбранныйЭлемент.Начало, "ДФ='HH:mm'") + " - " + Формат(ВыбранныйЭлемент.Конец, "ДФ='HH:mm'");
		Объект.ВыбраннаяДлительность = (ВыбранныйЭлемент.Конец - ВыбранныйЭлемент.Начало) / 3600;
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ПланировщикПроверкаПеретаскивания(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка)
	// Allow dragging
	СтандартнаяОбработка = Истина;
КонецПроцедуры

&НаКлиенте
Процедура ПланировщикПеретаскивание(Элемент, ПараметрыПеретаскивания, СтандартнаяОбработка)
	// Handle drag completion - update shift time
	СтандартнаяОбработка = Ложь;

	// In real app: save new time to database
	Сообщить("Смена перенесена на: " + Формат(ПараметрыПеретаскивания.НовоеНачало, "ДФ='HH:mm'") + " - " + Формат(ПараметрыПеретаскивания.НовыйКонец, "ДФ='HH:mm'"));

	// Refresh planner
	ОбновитьПланировщикНаСервере();
КонецПроцедуры

// ============================================
// Table Events
// ============================================

&НаКлиенте
Процедура ТаблицаСменПриАктивизацииСтроки(Элемент)
	// Show details for selected table row
	ОбновитьДеталиИзТаблицыНаСервере();
КонецПроцедуры

// ============================================
// Commands
// ============================================

&НаКлиенте
Процедура ОбновитьКоманда(Команда)
	ОбновитьПланировщикНаСервере();
	Сообщить("Расписание обновлено");
КонецПроцедуры

&НаКлиенте
Процедура ПредыдущийДеньКоманда(Команда)
	Объект.ТекущаяДата = Объект.ТекущаяДата - 86400; // -1 day
	ОбновитьПланировщикНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура СледующийДеньКоманда(Команда)
	Объект.ТекущаяДата = Объект.ТекущаяДата + 86400; // +1 day
	ОбновитьПланировщикНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура ДобавитьСменуКоманда(Команда)
	// In real app: open dialog to add new shift
	Сообщить("Добавление смены... (в реальном приложении откроется диалог)");
КонецПроцедуры

// ============================================
// Helper Procedures
// ============================================

&НаКлиенте
Процедура ОчиститьДеталиСмены()
	Объект.ВыбранныйОператор = "";
	Объект.ВыбранныйТипСмены = "";
	Объект.ВыбранноеВремя = "";
	Объект.ВыбраннаяДлительность = 0;
КонецПроцедуры

&НаСервере
Процедура ЗагрузитьДемоРасписаниеНаСервере()
	// Clear and load demo schedule
	ЖурналСмен.Очистить();

	// Demo operators with different shift types
	// Day shift: 09:00 - 18:00 (green)
	// Evening shift: 14:00 - 22:00 (blue)
	// Night shift: 22:00 - 06:00 (purple)
	// Morning shift: 06:00 - 14:00 (orange)

	ДобавитьСменуВЖурнал("Иванов И.И.", 9, 18, "Дневная");
	ДобавитьСменуВЖурнал("Иванов И.И.", 22, 30, "Ночная"); // 22:00 - 06:00 next day

	ДобавитьСменуВЖурнал("Петров П.П.", 14, 22, "Вечерняя");

	ДобавитьСменуВЖурнал("Сидорова А.А.", 9, 14, "Утренняя");
	ДобавитьСменуВЖурнал("Сидорова А.А.", 18, 22, "Вечерняя");

	ДобавитьСменуВЖурнал("Козлов К.К.", 6, 14, "Утренняя");

	ДобавитьСменуВЖурнал("Новикова Н.Н.", 9, 18, "Дневная");
КонецПроцедуры

&НаСервере
Процедура ДобавитьСменуВЖурнал(Оператор, ЧасНачала, ЧасКонца, ТипСмены)
	НоваяСтрока = ЖурналСмен.Добавить();
	НоваяСтрока.Оператор = Оператор;
	НоваяСтрока.ДатаНачала = НачалоДня(Объект.ТекущаяДата) + ЧасНачала * 3600;

	// Handle shifts that span midnight
	Если ЧасКонца > 24 Тогда
		НоваяСтрока.ДатаОкончания = НачалоДня(Объект.ТекущаяДата) + (ЧасКонца - 24) * 3600 + 86400;
	Иначе
		НоваяСтрока.ДатаОкончания = НачалоДня(Объект.ТекущаяДата) + ЧасКонца * 3600;
	КонецЕсли;

	НоваяСтрока.ТипСмены = ТипСмены;
КонецПроцедуры

&НаСервере
Процедура ИнициализироватьПланировщик()
	// Set planner display period (6:00 - 24:00 for full day view)
	НачалоПериода = НачалоДня(Объект.ТекущаяДата) + 6 * 3600;
	КонецПериода = НачалоДня(Объект.ТекущаяДата) + 24 * 3600;

	Планировщик.ТекущиеПериодыОтображения.Очистить();
	Планировщик.ТекущиеПериодыОтображения.Добавить(НачалоПериода, КонецПериода);

	// Setup dimension "Оператор" with operator rows
	// Structure: Измерения -> Измерение.Элементы -> ЭлементИзмерения
	Планировщик.Измерения.Очистить();

	// Collect unique operators
	Операторы = Новый Массив;
	Для Каждого СтрокаСмены Из ЖурналСмен Цикл
		Если Операторы.Найти(СтрокаСмены.Оператор) = Неопределено Тогда
			Операторы.Добавить(СтрокаСмены.Оператор);
		КонецЕсли;
	КонецЦикла;

	// Create dimension "Оператор"
	ИзмерениеОператор = Планировщик.Измерения.Добавить("Оператор");

	// Add operator rows as dimension elements
	Для Каждого ИмяОператора Из Операторы Цикл
		ЭлементИзмерения = ИзмерениеОператор.Элементы.Добавить(ИмяОператора);
		ЭлементИзмерения.Текст = ИмяОператора;
	КонецЦикла;

	// Add schedule items
	ЗаполнитьЭлементыПланировщика();
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьЭлементыПланировщика()
	// Clear existing items
	Планировщик.Элементы.Очистить();

	// Add items from schedule journal
	Для Каждого СтрокаСмены Из ЖурналСмен Цикл
		// Create item
		ЭлементПланировщика = Планировщик.Элементы.Добавить(СтрокаСмены.ДатаНачала, СтрокаСмены.ДатаОкончания);

		// Set dimension value (which row this item belongs to)
		СоответствиеИзмерений = Новый Соответствие;
		СоответствиеИзмерений.Вставить("Оператор", СтрокаСмены.Оператор);
		ЭлементПланировщика.ЗначенияИзмерений = Новый ФиксированноеСоответствие(СоответствиеИзмерений);

		// Set text and appearance
		ЭлементПланировщика.Текст = СтрокаСмены.ТипСмены;

		// Color by shift type
		Если СтрокаСмены.ТипСмены = "Дневная" Тогда
			ЭлементПланировщика.ЦветФона = Новый Цвет(144, 238, 144); // Light green
			ЭлементПланировщика.ЦветТекста = Новый Цвет(0, 100, 0);   // Dark green
		ИначеЕсли СтрокаСмены.ТипСмены = "Вечерняя" Тогда
			ЭлементПланировщика.ЦветФона = Новый Цвет(135, 206, 250); // Light blue
			ЭлементПланировщика.ЦветТекста = Новый Цвет(0, 0, 139);   // Dark blue
		ИначеЕсли СтрокаСмены.ТипСмены = "Ночная" Тогда
			ЭлементПланировщика.ЦветФона = Новый Цвет(221, 160, 221); // Plum
			ЭлементПланировщика.ЦветТекста = Новый Цвет(75, 0, 130);  // Indigo
		ИначеЕсли СтрокаСмены.ТипСмены = "Утренняя" Тогда
			ЭлементПланировщика.ЦветФона = Новый Цвет(255, 218, 185); // Peach
			ЭлементПланировщика.ЦветТекста = Новый Цвет(139, 69, 19); // Saddle brown
		Иначе
			ЭлементПланировщика.ЦветФона = Новый Цвет(211, 211, 211); // Light gray
			ЭлементПланировщика.ЦветТекста = Новый Цвет(0, 0, 0);     // Black
		КонецЕсли;

		// Store additional data in Значение for later use
		ДанныеСмены = Новый Структура;
		ДанныеСмены.Вставить("Оператор", СтрокаСмены.Оператор);
		ДанныеСмены.Вставить("ТипСмены", СтрокаСмены.ТипСмены);
		ДанныеСмены.Вставить("ИдентификаторСтроки", ЖурналСмен.Индекс(СтрокаСмены));
		ЭлементПланировщика.Значение = ДанныеСмены;
	КонецЦикла;
КонецПроцедуры

&НаСервере
Процедура ОбновитьПланировщикНаСервере()
	// Reload schedule data for current date
	ЗагрузитьДемоРасписаниеНаСервере();

	// Update planner display period
	НачалоПериода = НачалоДня(Объект.ТекущаяДата) + 6 * 3600;
	КонецПериода = НачалоДня(Объект.ТекущаяДата) + 24 * 3600;

	Планировщик.ТекущиеПериодыОтображения.Очистить();
	Планировщик.ТекущиеПериодыОтображения.Добавить(НачалоПериода, КонецПериода);

	// Rebuild dimensions
	Планировщик.Измерения.Очистить();
	Операторы = Новый Массив;
	Для Каждого СтрокаСмены Из ЖурналСмен Цикл
		Если Операторы.Найти(СтрокаСмены.Оператор) = Неопределено Тогда
			Операторы.Добавить(СтрокаСмены.Оператор);
		КонецЕсли;
	КонецЦикла;

	// Create dimension "Оператор" and add operator rows
	ИзмерениеОператор = Планировщик.Измерения.Добавить("Оператор");
	Для Каждого ИмяОператора Из Операторы Цикл
		ЭлементИзмерения = ИзмерениеОператор.Элементы.Добавить(ИмяОператора);
		ЭлементИзмерения.Текст = ИмяОператора;
	КонецЦикла;

	// Reload items
	ЗаполнитьЭлементыПланировщика();

	// Update statistics
	ОбновитьСтатистикуНаСервере();
КонецПроцедуры

&НаСервере
Процедура ОбновитьСтатистикуНаСервере()
	Объект.ВсегоСмен = ЖурналСмен.Количество();

	// Count unique operators
	Операторы = Новый Соответствие;
	ОбщееВремя = 0;

	Для Каждого СтрокаСмены Из ЖурналСмен Цикл
		Операторы.Вставить(СтрокаСмены.Оператор, Истина);
		ОбщееВремя = ОбщееВремя + (СтрокаСмены.ДатаОкончания - СтрокаСмены.ДатаНачала) / 3600;
	КонецЦикла;

	Объект.ОператоровНаЛинии = Операторы.Количество();

	Если Объект.ВсегоСмен > 0 Тогда
		Объект.СреднееВремяСмены = Окр(ОбщееВремя / Объект.ВсегоСмен, 1);
	Иначе
		Объект.СреднееВремяСмены = 0;
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура ОбновитьДеталиИзТаблицыНаСервере()
	ТекущаяСтрока = Элементы.ТаблицаСмен.ТекущаяСтрока;
	Если ТекущаяСтрока = Неопределено Тогда
		Объект.ВыбранныйОператор = "";
		Объект.ВыбранныйТипСмены = "";
		Объект.ВыбранноеВремя = "";
		Объект.ВыбраннаяДлительность = 0;
		Возврат;
	КонецЕсли;

	ДанныеСтроки = ЖурналСмен.НайтиПоИдентификатору(ТекущаяСтрока);
	Если ДанныеСтроки = Неопределено Тогда
		Возврат;
	КонецЕсли;

	Объект.ВыбранныйОператор = ДанныеСтроки.Оператор;
	Объект.ВыбранныйТипСмены = ДанныеСтроки.ТипСмены;
	Объект.ВыбранноеВремя = Формат(ДанныеСтроки.ДатаНачала, "ДФ='HH:mm'") + " - " + Формат(ДанныеСтроки.ДатаОкончания, "ДФ='HH:mm'");
	Объект.ВыбраннаяДлительность = (ДанныеСтроки.ДатаОкончания - ДанныеСтроки.ДатаНачала) / 3600;
КонецПроцедуры
