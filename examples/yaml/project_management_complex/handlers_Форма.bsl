// ============================================================================
// ГОЛОВНА ФОРМА (Форма)
// ============================================================================

// ────────────────────────────────────────────────────────────────────────────
// События форми
// ────────────────────────────────────────────────────────────────────────────

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	// Ініціалізація форми при відкритті
	ЗаполнитьТестовымиДаннымиНаСервере();
	ОбновитьДанныеНаСервере();
	УстановитьВидимостьЭлементов();
	ОбновитьСтатистику();
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	// Серверна ініціалізація
	ИнициализироватьНастройкиПоУмолчанию();
	ЗагрузитьСохраненныеНастройки();

	// Встановлення заголовків колонок
	УстановитьЗаголовкиКолонок();

	// Ініціалізація дат фільтра
	Если НЕ ЗначениеЗаполнено(Объект.ФильтрДатаНачала) Тогда
		Объект.ФильтрДатаНачала = НачалоМесяца(ТекущаяДата());
	КонецЕсли;

	Если НЕ ЗначениеЗаполнено(Объект.ФильтрДатаОкончания) Тогда
		Объект.ФильтрДатаОкончания = КонецМесяца(ТекущаяДата());
	КонецЕсли;

	// Встановлення версії даних
	Объект.ВерсияДанных = "v2.22.0";
КонецПроцедуры

// ────────────────────────────────────────────────────────────────────────────
// События зміни фільтрів
// ────────────────────────────────────────────────────────────────────────────

&НаКлиенте
Процедура ПриИзмененииФильтра(Элемент)
	ПрименитьФильтрыПроектов();
КонецПроцедуры

&НаКлиенте
Процедура ПриИзмененииФильтраЗадач(Элемент)
	ПрименитьФильтрыЗадач();
КонецПроцедуры

// ────────────────────────────────────────────────────────────────────────────
// События таблиць (OnActivateRow, Selection)
// ────────────────────────────────────────────────────────────────────────────

&НаКлиенте
Процедура ПроектыПриАктивизацииСтроки(Элемент)
	// Master-detail: при виборі проекту оновлюємо інформацію
	ТекущаяСтрока = Элементы.ТаблицаПроектов.ТекущиеДанные;

	Если ТекущаяСтрока <> Неопределено Тогда
		Объект.ТекущийПроектИД = ТекущаяСтрока.ПроектИД;
		ОбновитьИнформациюПроектаНаСервере(ТекущаяСтрока.ПроектИД);
		ЗагрузитьЗадачиПроектаНаСервере(ТекущаяСтрока.ПроектИД);
	Иначе
		Объект.ТекущийПроектИД = "";
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура ОбновитьИнформациюПроектаНаСервере(ПроектИД)
	// Завантажуємо детальну інформацію про вибраний проект
	СтрокаПроекта = Объект.Проекты.НайтиСтроки(Новый Структура("ПроектИД", ПроектИД));

	Если СтрокаПроекта.Количество() > 0 Тогда
		Проект = СтрокаПроекта[0];

		// Формуємо текст статистики
		ТекстИнформации = СтрШаблон(
			"Проект: %1" + Символы.ПС +
			"Статус: %2, Приоритет: %3" + Символы.ПС +
			"Руководитель: %4" + Символы.ПС +
			"Прогресс: %5%%" + Символы.ПС +
			"Бюджет: %6, Фактические затраты: %7" + Символы.ПС +
			"Задач: %8, Участников: %9",
			Проект.Название,
			Проект.Статус,
			Проект.Приоритет,
			Проект.РуководительПроекта,
			Формат(Проект.Прогресс, "ЧЦ=3; ЧДЦ=0"),
			Формат(Проект.Бюджет, "ЧЦ=15; ЧДЦ=2"),
			Формат(Проект.ФактическиеЗатраты, "ЧЦ=15; ЧДЦ=2"),
			Формат(Проект.КоличествоЗадач, "ЧЦ=5; ЧГ=0"),
			Формат(Проект.КоличествоУчастников, "ЧЦ=5; ЧГ=0")
		);

		Элементы.НадписьДетальнаяИнформация.Заголовок = ТекстИнформации;
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура ЗагрузитьЗадачиПроектаНаСервере(ПроектИД)
	// Фільтруємо задачі по вибраному проекту
	Если Объект.ГруппировкаПоПроектам Тогда
		// Тут можна додати групування
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ПроектыВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	// Подвійний клік - відкриваємо картку проекту
	СтандартнаяОбработка = Ложь;
	РедактироватьПроект(Неопределено);
КонецПроцедуры

&НаКлиенте
Процедура ЗадачиПриАктивизацииСтроки(Элемент)
	ТекущаяСтрока = Элементы.ТаблицаЗадач.ТекущиеДанные;

	Если ТекущаяСтрока <> Неопределено Тогда
		Объект.ТекущаяЗадачаИД = ТекущаяСтрока.ЗадачаИД;
	Иначе
		Объект.ТекущаяЗадачаИД = "";
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ЗадачиВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	СтандартнаяОбработка = Ложь;
	РедактироватьЗадачу(Неопределено);
КонецПроцедуры

&НаКлиенте
Процедура ЗадачиПриНачалеРедактирования(Элемент, НоваяСтрока, Копирование)
	Если НоваяСтрока Тогда
		Элемент.ТекущиеДанные.ЗадачаИД = Строка(Новый УникальныйИдентификатор);
		Элемент.ТекущиеДанные.Автор = ИмяПользователя();
		Элемент.ТекущиеДанные.ДатаСоздания = ТекущаяДата();
		Элемент.ТекущиеДанные.Статус = "Новая";

		// Прив'язка до поточного проекту
		Если ЗначениеЗаполнено(Объект.ТекущийПроектИД) Тогда
			Элемент.ТекущиеДанные.ПроектИД = Объект.ТекущийПроектИД;
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура РесурсыПриАктивизацииСтроки(Элемент)
	// Можна додати логіку відображення інформації про ресурс
КонецПроцедуры

// ────────────────────────────────────────────────────────────────────────────
// Команди для проектів
// ────────────────────────────────────────────────────────────────────────────

&НаКлиенте
Процедура СоздатьПроект(Команда)
	// Відкриваємо картку нового проекту
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("РежимСоздания", Истина);
	ПараметрыФормы.Вставить("ИмяОсновнойФормы", ЭтаФорма.ИмяФормы);

	// Відкриваємо форму картки проекту
	ОткрытьФорму(
		"ВнешняяОбработка." + ЭтаФорма.ИмяФормы + ".Форма.КарточкаПроекта",
		ПараметрыФормы,
		ЭтаФорма,
		,
		,
		,
		Новый ОписаниеОповещения("ПослеЗакрытияКарточкиПроекта", ЭтотОбъект),
		РежимОткрытияОкнаФормы.БлокироватьОкноВладельца
	);
КонецПроцедуры

&НаКлиенте
Процедура РедактироватьПроект(Команда)
	ТекущаяСтрока = Элементы.ТаблицаПроектов.ТекущиеДанные;

	Если ТекущаяСтрока = Неопределено Тогда
		Сообщить("Выберите проект для редактирования!");
		Возврат;
	КонецЕсли;

	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("РежимСоздания", Ложь);
	ПараметрыФормы.Вставить("ПроектИД", ТекущаяСтрока.ПроектИД);
	ПараметрыФормы.Вставить("ИмяОсновнойФормы", ЭтаФорма.ИмяФормы);

	// Копіюємо дані проекту
	ПараметрыФормы.Вставить("ДанныеПроекта", СкопироватьСтрокуПроектаНаСервере(ТекущаяСтрока.ПроектИД));

	ОткрытьФорму(
		"ВнешняяОбработка." + ЭтаФорма.ИмяФормы + ".Форма.КарточкаПроекта",
		ПараметрыФормы,
		ЭтаФорма,
		,
		,
		,
		Новый ОписаниеОповещения("ПослеЗакрытияКарточкиПроекта", ЭтотОбъект),
		РежимОткрытияОкнаФормы.БлокироватьОкноВладельца
	);
КонецПроцедуры

&НаСервере
Функция СкопироватьСтрокуПроектаНаСервере(ПроектИД)
	СтрокиПроекта = Объект.Проекты.НайтиСтроки(Новый Структура("ПроектИД", ПроектИД));

	Если СтрокиПроекта.Количество() = 0 Тогда
		Возврат Неопределено;
	КонецЕсли;

	СтрокаПроекта = СтрокиПроекта[0];

	ДанныеПроекта = Новый Структура;
	ДанныеПроекта.Вставить("ПроектИД", СтрокаПроекта.ПроектИД);
	ДанныеПроекта.Вставить("Название", СтрокаПроекта.Название);
	ДанныеПроекта.Вставить("Код", СтрокаПроекта.Код);
	ДанныеПроекта.Вставить("Описание", СтрокаПроекта.Описание);
	ДанныеПроекта.Вставить("Статус", СтрокаПроекта.Статус);
	ДанныеПроекта.Вставить("Приоритет", СтрокаПроекта.Приоритет);
	ДанныеПроекта.Вставить("ДатаНачала", СтрокаПроекта.ДатаНачала);
	ДанныеПроекта.Вставить("ДатаОкончания", СтрокаПроекта.ДатаОкончания);
	ДанныеПроекта.Вставить("Бюджет", СтрокаПроекта.Бюджет);
	ДанныеПроекта.Вставить("ФактическиеЗатраты", СтрокаПроекта.ФактическиеЗатраты);
	ДанныеПроекта.Вставить("Прогресс", СтрокаПроекта.Прогресс);
	ДанныеПроекта.Вставить("РуководительПроекта", СтрокаПроекта.РуководительПроекта);
	ДанныеПроекта.Вставить("Заказчик", СтрокаПроекта.Заказчик);

	Возврат ДанныеПроекта;
КонецФункции

&НаКлиенте
Процедура ПослеЗакрытияКарточкиПроекта(РезультатЗакрытия, ДополнительныеПараметры) Экспорт
	Если РезультатЗакрытия <> Неопределено И РезультатЗакрытия.Свойство("Сохранено") И РезультатЗакрытия.Сохранено Тогда
		// Оновлюємо дані після збереження
		СохранитьДанныеПроектаНаСервере(РезультатЗакрытия.ДанныеПроекта, РезультатЗакрытия.РежимСоздания);
		ОбновитьДанныеНаСервере();
		Сообщить("Проект сохранен успешно!");
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура СохранитьДанныеПроектаНаСервере(ДанныеПроекта, РежимСоздания)
	Если РежимСоздания Тогда
		// Створення нового проекту
		НоваяСтрока = Объект.Проекты.Добавить();
		НоваяСтрока.ПроектИД = Строка(Новый УникальныйИдентификатор);
	Иначе
		// Редагування існуючого
		СтрокиПроекта = Объект.Проекты.НайтиСтроки(Новый Структура("ПроектИД", ДанныеПроекта.ПроектИД));
		Если СтрокиПроекта.Количество() = 0 Тогда
			Возврат;
		КонецЕсли;
		НоваяСтрока = СтрокиПроекта[0];
	КонецЕсли;

	// Копіюємо дані
	ЗаполнитьЗначенияСвойств(НоваяСтрока, ДанныеПроекта);
КонецПроцедуры

&НаКлиенте
Процедура УдалитьПроект(Команда)
	ТекущаяСтрока = Элементы.ТаблицаПроектов.ТекущиеДанные;

	Если ТекущаяСтрока = Неопределено Тогда
		Сообщить("Выберите проект для удаления!");
		Возврат;
	КонецЕсли;

	Ответ = Вопрос(
		СтрШаблон("Удалить проект ""%1""?", ТекущаяСтрока.Название),
		РежимДиалогаВопрос.ДаНет
	);

	Если Ответ = КодВозвратаДиалога.Да Тогда
		УдалитьПроектНаСервере(ТекущаяСтрока.ПроектИД);
		Сообщить("Проект удален!");
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура УдалитьПроектНаСервере(ПроектИД)
	СтрокиПроекта = Объект.Проекты.НайтиСтроки(Новый Структура("ПроектИД", ПроектИД));

	Для Каждого Строка Из СтрокиПроекта Цикл
		Объект.Проекты.Удалить(Строка);
	КонецЦикла;

	// Видаляємо пов'язані задачі
	СтрокиЗадач = Объект.ЗадачиПроекта.НайтиСтроки(Новый Структура("ПроектИД", ПроектИД));

	Для Каждого Строка Из СтрокиЗадач Цикл
		Объект.ЗадачиПроекта.Удалить(Строка);
	КонецЦикла;

	// Видаляємо ресурси
	СтрокиРесурсов = Объект.Ресурсы.НайтиСтроки(Новый Структура("ПроектИД", ПроектИД));

	Для Каждого Строка Из СтрокиРесурсов Цикл
		Объект.Ресурсы.Удалить(Строка);
	КонецЦикла;
КонецПроцедуры

&НаКлиенте
Процедура КопироватьПроект(Команда)
	ТекущаяСтрока = Элементы.ТаблицаПроектов.ТекущиеДанные;

	Если ТекущаяСтрока = Неопределено Тогда
		Сообщить("Выберите проект для копирования!");
		Возврат;
	КонецЕсли;

	КопироватьПроектНаСервере(ТекущаяСтрока.ПроектИД);
	Сообщить(СтрШаблон("Проект ""%1"" скопирован!", ТекущаяСтрока.Название));
КонецПроцедуры

&НаСервере
Процедура КопироватьПроектНаСервере(ПроектИД)
	СтрокиПроекта = Объект.Проекты.НайтиСтроки(Новый Структура("ПроектИД", ПроектИД));

	Если СтрокиПроекта.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;

	ИсходныйПроект = СтрокиПроекта[0];
	НовыйПроект = Объект.Проекты.Добавить();

	ЗаполнитьЗначенияСвойств(НовыйПроект, ИсходныйПроект);
	НовыйПроект.ПроектИД = Строка(Новый УникальныйИдентификатор);
	НовыйПроект.Название = ИсходныйПроект.Название + " (копия)";
	НовыйПроект.Код = "";
КонецПроцедуры

// ────────────────────────────────────────────────────────────────────────────
// Команди для задач
// ────────────────────────────────────────────────────────────────────────────

&НаКлиенте
Процедура СоздатьЗадачу(Команда)
	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("РежимСоздания", Истина);
	ПараметрыФормы.Вставить("ПроектИД", Объект.ТекущийПроектИД);
	ПараметрыФормы.Вставить("ИмяОсновнойФормы", ЭтаФорма.ИмяФормы);

	ОткрытьФорму(
		"ВнешняяОбработка." + ЭтаФорма.ИмяФормы + ".Форма.КарточкаЗадачи",
		ПараметрыФормы,
		ЭтаФорма,
		,
		,
		,
		Новый ОписаниеОповещения("ПослеЗакрытияКарточкиЗадачи", ЭтотОбъект),
		РежимОткрытияОкнаФормы.БлокироватьОкноВладельца
	);
КонецПроцедуры

&НаКлиенте
Процедура РедактироватьЗадачу(Команда)
	ТекущаяСтрока = Элементы.ТаблицаЗадач.ТекущиеДанные;

	Если ТекущаяСтрока = Неопределено Тогда
		Сообщить("Выберите задачу для редактирования!");
		Возврат;
	КонецЕсли;

	ПараметрыФормы = Новый Структура;
	ПараметрыФормы.Вставить("РежимСоздания", Ложь);
	ПараметрыФормы.Вставить("ЗадачаИД", ТекущаяСтрока.ЗадачаИД);
	ПараметрыФормы.Вставить("ИмяОсновнойФормы", ЭтаФорма.ИмяФормы);
	ПараметрыФормы.Вставить("ДанныеЗадачи", СкопироватьСтрокуЗадачиНаСервере(ТекущаяСтрока.ЗадачаИД));

	ОткрытьФорму(
		"ВнешняяОбработка." + ЭтаФорма.ИмяФормы + ".Форма.КарточкаЗадачи",
		ПараметрыФормы,
		ЭтаФорма,
		,
		,
		,
		Новый ОписаниеОповещения("ПослеЗакрытияКарточкиЗадачи", ЭтотОбъект),
		РежимОткрытияОкнаФормы.БлокироватьОкноВладельца
	);
КонецПроцедуры

&НаСервере
Функция СкопироватьСтрокуЗадачиНаСервере(ЗадачаИД)
	СтрокиЗадачи = Объект.ЗадачиПроекта.НайтиСтроки(Новый Структура("ЗадачаИД", ЗадачаИД));

	Если СтрокиЗадачи.Количество() = 0 Тогда
		Возврат Неопределено;
	КонецЕсли;

	СтрокаЗадачи = СтрокиЗадачи[0];

	ДанныеЗадачи = Новый Структура;
	Для Каждого Колонка Из Объект.ЗадачиПроекта.Колонки Цикл
		ДанныеЗадачи.Вставить(Колонка.Имя, СтрокаЗадачи[Колонка.Имя]);
	КонецЦикла;

	Возврат ДанныеЗадачи;
КонецФункции

&НаКлиенте
Процедура ПослеЗакрытияКарточкиЗадачи(РезультатЗакрытия, ДополнительныеПараметры) Экспорт
	Если РезультатЗакрытия <> Неопределено И РезультатЗакрытия.Свойство("Сохранено") И РезультатЗакрытия.Сохранено Тогда
		СохранитьДанныеЗадачиНаСервере(РезультатЗакрытия.ДанныеЗадачи, РезультатЗакрытия.РежимСоздания);
		ОбновитьДанныеНаСервере();
		Сообщить("Задача сохранена успешно!");
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура СохранитьДанныеЗадачиНаСервере(ДанныеЗадачи, РежимСоздания)
	Если РежимСоздания Тогда
		НоваяСтрока = Объект.ЗадачиПроекта.Добавить();
		НоваяСтрока.ЗадачаИД = Строка(Новый УникальныйИдентификатор);
	Иначе
		СтрокиЗадачи = Объект.ЗадачиПроекта.НайтиСтроки(Новый Структура("ЗадачаИД", ДанныеЗадачи.ЗадачаИД));
		Если СтрокиЗадачи.Количество() = 0 Тогда
			Возврат;
		КонецЕсли;
		НоваяСтрока = СтрокиЗадачи[0];
	КонецЕсли;

	ЗаполнитьЗначенияСвойств(НоваяСтрока, ДанныеЗадачи);
КонецПроцедуры

&НаКлиенте
Процедура УдалитьЗадачу(Команда)
	ТекущаяСтрока = Элементы.ТаблицаЗадач.ТекущиеДанные;

	Если ТекущаяСтрока = Неопределено Тогда
		Сообщить("Выберите задачу для удаления!");
		Возврат;
	КонецЕсли;

	Ответ = Вопрос(
		СтрШаблон("Удалить задачу ""%1""?", ТекущаяСтрока.Название),
		РежимДиалогаВопрос.ДаНет
	);

	Если Ответ = КодВозвратаДиалога.Да Тогда
		УдалитьЗадачуНаСервере(ТекущаяСтрока.ЗадачаИД);
		Сообщить("Задача удалена!");
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура УдалитьЗадачуНаСервере(ЗадачаИД)
	СтрокиЗадачи = Объект.ЗадачиПроекта.НайтиСтроки(Новый Структура("ЗадачаИД", ЗадачаИД));

	Для Каждого Строка Из СтрокиЗадачи Цикл
		Объект.ЗадачиПроекта.Удалить(Строка);
	КонецЦикла;
КонецПроцедуры

// ────────────────────────────────────────────────────────────────────────────
// Команди для ресурсів
// ────────────────────────────────────────────────────────────────────────────

&НаКлиенте
Процедура ДобавитьРесурс(Команда)
	Если НЕ ЗначениеЗаполнено(Объект.ТекущийПроектИД) Тогда
		Сообщить("Выберите проект для добавления ресурса!");
		Возврат;
	КонецЕсли;

	ДобавитьРесурсНаСервере();
	Сообщить("Добавьте данные ресурса в таблице");
КонецПроцедуры

&НаСервере
Процедура ДобавитьРесурсНаСервере()
	НоваяСтрока = Объект.Ресурсы.Добавить();
	НоваяСтрока.РесурсИД = Строка(Новый УникальныйИдентификатор);
	НоваяСтрока.ПроектИД = Объект.ТекущийПроектИД;
	НоваяСтрока.ТипРесурса = "Сотрудник";
	НоваяСтрока.Доступность = 100;
	НоваяСтрока.Статус = "Активный";
КонецПроцедуры

&НаКлиенте
Процедура УдалитьРесурс(Команда)
	ТекущаяСтрока = Элементы.ТаблицаРесурсов.ТекущиеДанные;

	Если ТекущаяСтрока = Неопределено Тогда
		Сообщить("Выберите ресурс для удаления!");
		Возврат;
	КонецЕсли;

	Объект.Ресурсы.Удалить(ТекущаяСтрока);
	Сообщить("Ресурс удален!");
КонецПроцедуры

// ────────────────────────────────────────────────────────────────────────────
// Загальні команди
// ────────────────────────────────────────────────────────────────────────────

&НаКлиенте
Процедура ОбновитьДанные(Команда)
	ОбновитьДанныеНаСервере();
	ОбновитьСтатистику();
	Сообщить("Данные обновлены!");
КонецПроцедуры

&НаСервере
Процедура ОбновитьДанныеНаСервере()
	// Оновлення кількості задач у проектах
	Для Каждого СтрокаПроекта Из Объект.Проекты Цикл
		СтрокиЗадач = Объект.ЗадачиПроекта.НайтиСтроки(Новый Структура("ПроектИД", СтрокаПроекта.ПроектИД));
		СтрокаПроекта.КоличествоЗадач = СтрокиЗадач.Количество();

		СтрокиРесурсов = Объект.Ресурсы.НайтиСтроки(Новый Структура("ПроектИД", СтрокаПроекта.ПроектИД));
		СтрокаПроекта.КоличествоУчастников = СтрокиРесурсов.Количество();
	КонецЦикла;

	Объект.ПоследнееОбновление = ТекущаяДата();
	Объект.КоличествоЗагруженных = Объект.Проекты.Количество() + Объект.ЗадачиПроекта.Количество();
КонецПроцедуры

&НаКлиенте
Процедура ЗагрузитьДанные(Команда)
	ЗагрузитьДанныеНаСервере();
	Сообщить("Данные загружены из файла!");
КонецПроцедуры

&НаСервере
Процедура ЗагрузитьДанныеНаСервере()
	// Тут може бути логіка завантаження з файлу
	Сообщить("Функция загрузки данных будет реализована");
КонецПроцедуры

&НаКлиенте
Процедура ВыгрузитьДанные(Команда)
	ВыгрузитьДанныеНаСервере();
	Сообщить("Данные выгружены в файл!");
КонецПроцедуры

&НаСервере
Процедура ВыгрузитьДанныеНаСервере()
	// Експорт у форматі, вказаному в налаштуваннях
	Формат = Объект.ФорматЭкспорта;

	Если НЕ ЗначениеЗаполнено(Формат) Тогда
		Формат = "XML";
	КонецЕсли;

	// Тут логіка експорту
КонецПроцедуры

&НаКлиенте
Процедура СформироватьОтчет(Команда)
	// Відкриваємо форму звітів
	ОткрытьФорму(
		"ВнешняяОбработка." + ЭтаФорма.ИмяФормы + ".Форма.ФормаОтчетов",
		Новый Структура("ИмяОсновнойФормы", ЭтаФорма.ИмяФормы),
		ЭтаФорма,
		,
		,
		,
		,
		РежимОткрытияОкнаФормы.БлокироватьОкноВладельца
	);
КонецПроцедуры

&НаКлиенте
Процедура ОткрытьНастройки(Команда)
	// Відкриваємо форму налаштувань
	ОткрытьФорму(
		"ВнешняяОбработка." + ЭтаФорма.ИмяФормы + ".Форма.ФормаНастроек",
		Новый Структура("ИмяОсновнойФормы", ЭтаФорма.ИмяФормы),
		ЭтаФорма,
		,
		,
		,
		Новый ОписаниеОповещения("ПослеЗакрытияНастроек", ЭтотОбъект),
		РежимОткрытияОкнаФормы.БлокироватьОкноВладельца
	);
КонецПроцедуры

&НаКлиенте
Процедура ПослеЗакрытияНастроек(РезультатЗакрытия, ДополнительныеПараметры) Экспорт
	Если РезультатЗакрытия <> Неопределено И РезультатЗакрытия.Свойство("Сохранено") И РезультатЗакрытия.Сохранено Тогда
		// Застосовуємо налаштування
		ПрименитьНастройкиНаСервере(РезультатЗакрытия.Настройки);
		Сообщить("Настройки применены!");
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура ПрименитьНастройкиНаСервере(Настройки)
	ЗаполнитьЗначенияСвойств(ЭтотОбъект.Объект, Настройки);
КонецПроцедуры

&НаКлиенте
Процедура ОтобразитьСтатистику(Команда)
	СформироватьСтатистикуНаСервере();
	Сообщить("Статистика сформирована!");
КонецПроцедуры

&НаСервере
Процедура СформироватьСтатистикуНаСервере()
	СтатистикаПроектов.Очистить();

	// Загальна статистика
	НоваяСтрока = СтатистикаПроектов.Добавить();
	НоваяСтрока.Показатель = "Всего проектов";
	НоваяСтрока.Значение = Строка(Объект.Проекты.Количество());

	НоваяСтрока = СтатистикаПроектов.Добавить();
	НоваяСтрока.Показатель = "Всего задач";
	НоваяСтрока.Значение = Строка(Объект.ЗадачиПроекта.Количество());

	НоваяСтрока = СтатистикаПроектов.Добавить();
	НоваяСтрока.Показатель = "Всего ресурсов";
	НоваяСтрока.Значение = Строка(Объект.Ресурсы.Количество());
КонецПроцедуры

// ────────────────────────────────────────────────────────────────────────────
// Helper functions
// ────────────────────────────────────────────────────────────────────────────

&НаКлиенте
Процедура УстановитьВидимостьЭлементов()
	// Налаштування видимості елементів
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьСтатистику()
	// Оновлення статистики на клієнті
КонецПроцедуры

&НаСервере
Процедура ИнициализироватьНастройкиПоУмолчанию()
	Если Объект.АвтообновлениеСекунд = 0 Тогда
		Объект.АвтообновлениеСекунд = 60;
	КонецЕсли;

	Если НЕ ЗначениеЗаполнено(Объект.РежимОтображения) Тогда
		Объект.РежимОтображения = "Таблица";
	КонецЕсли;

	Если НЕ ЗначениеЗаполнено(Объект.ЦветовойРежим) Тогда
		Объект.ЦветовойРежим = "Светлая";
	КонецЕсли;

	Если Объект.РазмерШрифта = 0 Тогда
		Объект.РазмерШрифта = 10;
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура ЗагрузитьСохраненныеНастройки()
	// Завантаження збережених налаштувань
КонецПроцедуры

&НаСервере
Процедура УстановитьЗаголовкиКолонок()
	// Налаштування заголовків колонок таблиць
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьТестовымиДаннымиНаСервере()
	// Якщо немає даних - додаємо тестові
	Если Объект.Проекты.Количество() = 0 Тогда
		// Проект 1
		НовыйПроект = Объект.Проекты.Добавить();
		НовыйПроект.ПроектИД = Строка(Новый УникальныйИдентификатор);
		НовыйПроект.Код = "PRJ-001";
		НовыйПроект.Название = "Модернизация системы учета";
		НовыйПроект.Описание = "Переход на новую версию 1С";
		НовыйПроект.Статус = "Активный";
		НовыйПроект.Приоритет = "Высокий";
		НовыйПроект.ДатаНачала = '20250101';
		НовыйПроект.ДатаОкончания = '20250630';
		НовыйПроект.Бюджет = 500000;
		НовыйПроект.ФактическиеЗатраты = 125000;
		НовыйПроект.Прогресс = 25;
		НовыйПроект.РуководительПроекта = "Иванов И.И.";
		НовыйПроект.Заказчик = "Департамент IT";

		// Проект 2
		НовыйПроект = Объект.Проекты.Добавить();
		НовыйПроект.ПроектИД = Строка(Новый УникальныйИдентификатор);
		НовыйПроект.Код = "PRJ-002";
		НовыйПроект.Название = "Внедрение CRM";
		НовыйПроект.Описание = "Автоматизация работы с клиентами";
		НовыйПроект.Статус = "Планирование";
		НовыйПроект.Приоритет = "Средний";
		НовыйПроект.ДатаНачала = '20250201';
		НовыйПроект.ДатаОкончания = '20250831';
		НовыйПроект.Бюджет = 800000;
		НовыйПроект.ФактическиеЗатраты = 0;
		НовыйПроект.Прогресс = 5;
		НовыйПроект.РуководительПроекта = "Петрова П.П.";
		НовыйПроект.Заказчик = "Отдел продаж";

		// Проект 3
		НовыйПроект = Объект.Проекты.Добавить();
		НовыйПроект.ПроектИД = Строка(Новый УникальныйИдентификатор);
		НовыйПроект.Код = "PRJ-003";
		НовыйПроект.Название = "Разработка мобильного приложения";
		НовыйПроект.Описание = "iOS и Android приложение для сотрудников";
		НовыйПроект.Статус = "В работе";
		НовыйПроект.Приоритет = "Критический";
		НовыйПроект.ДатаНачала = '20241201';
		НовыйПроект.ДатаОкончания = '20250430';
		НовыйПроект.Бюджет = 1200000;
		НовыйПроект.ФактическиеЗатраты = 600000;
		НовыйПроект.Прогресс = 50;
		НовыйПроект.РуководительПроекта = "Сидоров С.С.";
		НовыйПроект.Заказчик = "Генеральный директор";

		// Задачі для проектів
		ПроектИД1 = Объект.Проекты[0].ПроектИД;

		НоваяЗадача = Объект.ЗадачиПроекта.Добавить();
		НоваяЗадача.ЗадачаИД = Строка(Новый УникальныйИдентификатор);
		НоваяЗадача.ПроектИД = ПроектИД1;
		НоваяЗадача.Название = "Анализ текущей системы";
		НоваяЗадача.Описание = "Провести аудит существующей конфигурации";
		НоваяЗадача.Статус = "Выполнена";
		НоваяЗадача.Приоритет = "Высокий";
		НоваяЗадача.Тип = "Документация";
		НоваяЗадача.Исполнитель = "Иванов И.И.";
		НоваяЗадача.Автор = "Петрова П.П.";
		НоваяЗадача.ДатаСоздания = '20241215';
		НоваяЗадача.ДатаНачала = '20250102';
		НоваяЗадача.ДатаОкончания = '20250115';
		НоваяЗадача.ПлановоеВремя = 40;
		НоваяЗадача.ФактическоеВремя = 38;
		НоваяЗадача.ЗавершеноПроцентов = 100;

		НоваяЗадача = Объект.ЗадачиПроекта.Добавить();
		НоваяЗадача.ЗадачаИД = Строка(Новый УникальныйИдентификатор);
		НоваяЗадача.ПроектИД = ПроектИД1;
		НоваяЗадача.Название = "Разработка плана миграции";
		НоваяЗадача.Описание = "Составить детальный план переноса данных";
		НоваяЗадача.Статус = "В работе";
		НоваяЗадача.Приоритет = "Высокий";
		НоваяЗадача.Тип = "Разработка";
		НоваяЗадача.Исполнитель = "Сидоров С.С.";
		НоваяЗадача.Автор = "Иванов И.И.";
		НоваяЗадача.ДатаСоздания = '20250110';
		НоваяЗадача.ДатаНачала = '20250116';
		НоваяЗадача.ДатаОкончания = '20250201';
		НоваяЗадача.ПлановоеВремя = 80;
		НоваяЗадача.ФактическоеВремя = 40;
		НоваяЗадача.ЗавершеноПроцентов = 50;

		// Ресурси
		НовыйРесурс = Объект.Ресурсы.Добавить();
		НовыйРесурс.РесурсИД = Строка(Новый УникальныйИдентификатор);
		НовыйРесурс.ПроектИД = ПроектИД1;
		НовыйРесурс.ИмяРесурса = "Иванов Иван Иванович";
		НовыйРесурс.ТипРесурса = "Сотрудник";
		НовыйРесурс.Роль = "Руководитель проекта";
		НовыйРесурс.Email = "ivanov@company.com";
		НовыйРесурс.Телефон = "+7 (123) 456-78-90";
		НовыйРесурс.Доступность = 100;
		НовыйРесурс.СтоимостьЧаса = 3000;
		НовыйРесурс.ЗагрузкаЧасов = 160;
		НовыйРесурс.Статус = "Активный";

		НовыйРесурс = Объект.Ресурсы.Добавить();
		НовыйРесурс.РесурсИД = Строка(Новый УникальныйИдентификатор);
		НовыйРесурс.ПроектИД = ПроектИД1;
		НовыйРесурс.ИмяРесурса = "Петрова Петра Петровна";
		НовыйРесурс.ТипРесурса = "Сотрудник";
		НовыйРесурс.Роль = "Бизнес-аналитик";
		НовыйРесурс.Email = "petrova@company.com";
		НовыйРесурс.Телефон = "+7 (123) 456-78-91";
		НовыйРесурс.Доступность = 80;
		НовыйРесурс.СтоимостьЧаса = 2500;
		НовыйРесурс.ЗагрузкаЧасов = 128;
		НовыйРесурс.Статус = "Активный";
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ПрименитьФильтрыПроектов()
	// Застосування фільтрів до таблиці проектів
КонецПроцедуры

&НаКлиенте
Процедура ПрименитьФильтрыЗадач()
	// Застосування фільтрів до таблиці задач
КонецПроцедуры
