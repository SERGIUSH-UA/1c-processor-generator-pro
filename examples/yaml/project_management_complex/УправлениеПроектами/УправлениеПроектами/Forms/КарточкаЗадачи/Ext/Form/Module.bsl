#Область ОбработчикиСобытийФормы

&НаКлиенте
Процедура ПриОткрытии(Отказ)

	Если Параметры.Свойство("РежимСоздания") Тогда
		РежимСоздания = Параметры.РежимСоздания;
	Иначе
		РежимСоздания = Истина;
	КонецЕсли;

	Если НЕ РежимСоздания И Параметры.Свойство("ДанныеЗадачи") Тогда
		ЗагрузитьДанныеЗадачиНаСервере(Параметры.ДанныеЗадачи);
	Иначе
		ИнициализироватьНовуюЗадачуНаСервере();
	КонецЕсли;

	Если Параметры.Свойство("ИмяОсновнойФормы") Тогда
		ИмяОсновнойФормы = Параметры.ИмяОсновнойФормы;
	КонецЕсли;

	Если Параметры.Свойство("ПроектИД") И ЗначениеЗаполнено(Параметры.ПроектИД) Тогда
		Объект.ЗадачиПроекта[0].ПроектИД = Параметры.ПроектИД;
	КонецЕсли;

	// Завантаження тестових коментарів
	ЗаполнитьТестовымиКомментариями();

КонецПроцедуры

&НаСервере
Процедура ПриОткрытииНаСервере()
	// Вставить содержимое обработчика.
КонецПроцедуры

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)

	// Серверна ініціалізація

КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

// Обработчики событий элементов формы

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура СохранитьЗадачу(Команда)

	Если НЕ ПроверитьЗаполнениеЗадачиНаСервере() Тогда
		Возврат;
	КонецЕсли;

	Результат = Новый Структура;
	Результат.Вставить("Сохранено", Истина);
	Результат.Вставить("РежимСоздания", РежимСоздания);
	Результат.Вставить("ДанныеЗадачи", ПолучитьДанныеЗадачиНаСервере());

	Закрыть(Результат);

КонецПроцедуры

&НаКлиенте
Процедура ОтменитьЗадачу(Команда)

	Закрыть();

КонецПроцедуры

&НаКлиенте
Процедура ДобавитьКомментарий(Команда)

	НовыйКомментарий = КомментарииЗадачи.Добавить();
	НовыйКомментарий.Автор = ИмяПользователя();
	НовыйКомментарий.Дата = ТекущаяДата();
	НовыйКомментарий.Тип = "Комментарий";
	Сообщить("Добавьте текст комментария");

КонецПроцедуры

&НаКлиенте
Процедура УдалитьКомментарий(Команда)

	ТекущаяСтрока = Элементы.ТаблицаКомментариев.ТекущиеДанные;

	Если ТекущаяСтрока <> Неопределено Тогда
		КомментарииЗадачи.Удалить(ТекущаяСтрока);
		Сообщить("Комментарий удален");
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура ИзменитьСтатус(Команда)

	Задача = Объект.ЗадачиПроекта[0];

	// Переключення статусів
	Если Задача.Статус = "Новая" Тогда
		Задача.Статус = "В работе";
	ИначеЕсли Задача.Статус = "В работе" Тогда
		Задача.Статус = "На проверке";
	ИначеЕсли Задача.Статус = "На проверке" Тогда
		Задача.Статус = "Выполнена";
	ИначеЕсли Задача.Статус = "Выполнена" Тогда
		Задача.Статус = "Закрыта";
	КонецЕсли;

	Сообщить(СтрШаблон("Статус изменен на: %1", Задача.Статус));

КонецПроцедуры

&НаКлиенте
Процедура НазначитьИсполнителя(Команда)

	Сообщить("Выберите исполнителя из списка (функция в разработке)");

КонецПроцедуры

#КонецОбласти


#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура ЗагрузитьДанныеЗадачиНаСервере(ДанныеЗадачи)

	ЗаполнитьЗначенияСвойств(ЭтотОбъект.Объект.ЗадачиПроекта[0], ДанныеЗадачи);

КонецПроцедуры

&НаСервере
Процедура ИнициализироватьНовуюЗадачуНаСервере()

	НоваяСтрока = Объект.ЗадачиПроекта.Добавить();
	НоваяСтрока.ЗадачаИД = Строка(Новый УникальныйИдентификатор);
	НоваяСтрока.Статус = "Новая";
	НоваяСтрока.Приоритет = "Средний";
	НоваяСтрока.Тип = "Разработка";
	НоваяСтрока.Автор = ИмяПользователя();
	НоваяСтрока.ДатаСоздания = ТекущаяДата();
	НоваяСтрока.ЗавершеноПроцентов = 0;

КонецПроцедуры

&НаСервере
Функция ПроверитьЗаполнениеЗадачиНаСервере()

	Задача = Объект.ЗадачиПроекта[0];

	Если НЕ ЗначениеЗаполнено(Задача.Название) Тогда
		Сообщить("Укажите название задачи!");
		Возврат Ложь;
	КонецЕсли;

	Возврат Истина;

КонецФункции

&НаСервере
Функция ПолучитьДанныеЗадачиНаСервере()

	Задача = Объект.ЗадачиПроекта[0];

	ДанныеЗадачи = Новый Структура;
	Для Каждого Колонка Из Объект.ЗадачиПроекта.Колонки Цикл
		ДанныеЗадачи.Вставить(Колонка.Имя, Задача[Колонка.Имя]);
	КонецЦикла;

	Возврат ДанныеЗадачи;

КонецФункции

&НаКлиенте
Процедура КомментарииВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)

	СтандартнаяОбработка = Ложь;
	ТекущаяСтрока = Элементы.ТаблицаКомментариев.ТекущиеДанные;

	Если ТекущаяСтрока <> Неопределено Тогда
		ПоказатьЗначение(, ТекущаяСтрока.Комментарий);
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьТестовымиКомментариями()

	Если КомментарииЗадачи.Количество() = 0 Тогда
		Комментарий = КомментарииЗадачи.Добавить();
		Комментарий.Автор = "Иванов И.И.";
		Комментарий.Дата = '20250110120000';
		Комментарий.Тип = "Комментарий";
		Комментарий.Комментарий = "Задача принята в работу";

		Комментарий = КомментарииЗадачи.Добавить();
		Комментарий.Автор = "Петрова П.П.";
		Комментарий.Дата = '20250111150000';
		Комментарий.Тип = "Вопрос";
		Комментарий.Комментарий = "Нужно уточнить требования к отчету";

		Комментарий = КомментарииЗадачи.Добавить();
		Комментарий.Автор = "Иванов И.И.";
		Комментарий.Дата = '20250111160000';
		Комментарий.Тип = "Ответ";
		Комментарий.Комментарий = "Требования уточнены, см. приложение";
	КонецЕсли;

КонецПроцедуры

#КонецОбласти