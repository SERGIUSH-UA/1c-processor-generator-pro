// ========================================================================
// Complex Procedural Tests for УправлениеПроектами
// Testing Framework v2.16.0+ verification
// ========================================================================

// ========================================================================
// Test 1: Complete Project Lifecycle
// ========================================================================
&НаСервере
Процедура Тест_CompleteProjectLifecycle() Экспорт
	// Simulate complete project lifecycle: create → add tasks → complete → archive

	// Step 1: Create project
	НоваяСтрока = Объект.Проекты.Добавить();
	НоваяСтрока.ПроектИД = "LIFECYCLE-001";
	НоваяСтрока.Код = "LIFE-001";
	НоваяСтрока.Название = "Lifecycle Test Project";
	НоваяСтрока.Статус = "Планирование";
	НоваяСтрока.Приоритет = "Средний";
	НоваяСтрока.Бюджет = 500000;
	НоваяСтрока.Прогресс = 0;
	НоваяСтрока.КоличествоЗадач = 0;

	Если Объект.Проекты.Количество() <> 1 Тогда
		ВызватьИсключение "Failed to add project: expected 1 row, got " + Объект.Проекты.Количество();
	КонецЕсли;

	// Step 2: Add tasks to project
	Для Индекс = 1 По 5 Цикл
		Задача = Объект.ЗадачиПроекта.Добавить();
		Задача.ПроектИД = "LIFECYCLE-001";
		Задача.ЗадачаИД = "TASK-" + Формат(Индекс, "ЧЦ=3; ЧВН=");
		Задача.Название = "Task " + Индекс;
		Задача.Статус = "Новая";
		Задача.Приоритет = "Средний";
		Задача.ПлановоеВремя = 20;
		Задача.ФактическоеВремя = 0;
		Задача.ЗавершеноПроцентов = 0;
	КонецЦикла;

	Если Объект.ЗадачиПроекта.Количество() <> 5 Тогда
		ВызватьИсключение "Failed to add tasks: expected 5 rows, got " + Объект.ЗадачиПроекта.Количество();
	КонецЕсли;

	// Step 3: Mark tasks as in progress
	Для Каждого Задача Из Объект.ЗадачиПроекта Цикл
		Если Задача.ПроектИД = "LIFECYCLE-001" Тогда
			Задача.Статус = "В работе";
			Задача.ЗавершеноПроцентов = 50;
			Задача.ФактическоеВремя = 10;
		КонецЕсли;
	КонецЦикла;

	// Step 4: Complete some tasks
	Счетчик = 0;
	Для Каждого Задача Из Объект.ЗадачиПроекта Цикл
		Если Задача.ПроектИД = "LIFECYCLE-001" И Счетчик < 3 Тогда
			Задача.Статус = "Выполнена";
			Задача.ЗавершеноПроцентов = 100;
			Задача.ФактическоеВремя = 20;
			Счетчик = Счетчик + 1;
		КонецЕсли;
	КонецЦикла;

	// Step 5: Update project status
	НоваяСтрока.Статус = "Активный";
	НоваяСтрока.Прогресс = 60;
	НоваяСтрока.КоличествоЗадач = 5;

	Если НоваяСтрока.Статус <> "Активный" Тогда
		ВызватьИсключение "Project status not updated correctly";
	КонецЕсли;

	Если НоваяСтрока.Прогресс <> 60 Тогда
		ВызватьИсключение СтрШаблон("Project progress incorrect: expected 60, got %1", НоваяСтрока.Прогресс);
	КонецЕсли;

КонецПроцедуры

// ========================================================================
// Test 2: Task Progress Calculation
// ========================================================================
&НаСервере
Процедура Тест_TaskProgressCalculation() Экспорт
	// Test complex calculation: planned vs actual time, progress percentage

	// Add project
	Проект = Объект.Проекты.Добавить();
	Проект.ПроектИД = "CALC-001";
	Проект.Название = "Calculation Test";
	Проект.Бюджет = 200000;

	// Add tasks with different progress levels
	ПлановоеВсего = 0;
	ФактическоеВсего = 0;

	// Task 1: Completed
	Задача1 = Объект.ЗадачиПроекта.Добавить();
	Задача1.ПроектИД = "CALC-001";
	Задача1.Название = "Completed Task";
	Задача1.ПлановоеВремя = 40;
	Задача1.ФактическоеВремя = 38;
	Задача1.ЗавершеноПроцентов = 100;
	ПлановоеВсего = ПлановоеВсего + 40;
	ФактическоеВсего = ФактическоеВсего + 38;

	// Task 2: In Progress
	Задача2 = Объект.ЗадачиПроекта.Добавить();
	Задача2.ПроектИД = "CALC-001";
	Задача2.Название = "In Progress Task";
	Задача2.ПлановоеВремя = 60;
	Задача2.ФактическоеВремя = 30;
	Задача2.ЗавершеноПроцентов = 50;
	ПлановоеВсего = ПлановоеВсего + 60;
	ФактическоеВсего = ФактическоеВсего + 30;

	// Task 3: Not Started
	Задача3 = Объект.ЗадачиПроекта.Добавить();
	Задача3.ПроектИД = "CALC-001";
	Задача3.Название = "Not Started Task";
	Задача3.ПлановоеВремя = 20;
	Задача3.ФактическоеВремя = 0;
	Задача3.ЗавершеноПроцентов = 0;
	ПлановоеВсего = ПлановоеВсего + 20;

	// Verify totals
	Если ПлановоеВсего <> 120 Тогда
		ВызватьИсключение СтрШаблон("Planned time calculation error: expected 120, got %1", ПлановоеВсего);
	КонецЕсли;

	Если ФактическоеВсего <> 68 Тогда
		ВызватьИсключение СтрШаблон("Actual time calculation error: expected 68, got %1", ФактическоеВсего);
	КонецЕсли;

	// Calculate average progress
	СреднийПрогресс = (100 + 50 + 0) / 3;
	Если СреднийПрогресс <> 50 Тогда
		ВызватьИсключение СтрШаблон("Average progress error: expected 50, got %1", СреднийПрогресс);
	КонецЕсли;

	// Update project with calculations
	Проект.Прогресс = СреднийПрогресс;
	Проект.КоличествоЗадач = 3;

КонецПроцедуры

// ========================================================================
// Test 3: Resource Allocation
// ========================================================================
&НаСервере
Процедура Тест_ResourceAllocation() Экспорт
	// Test resource allocation and cost calculation

	// Add project
	Проект = Объект.Проекты.Добавить();
	Проект.ПроектИД = "RES-001";
	Проект.Название = "Resource Test Project";
	Проект.Бюджет = 1000000;

	// Add resources
	ОбщаяСтоимость = 0;
	ОбщиеЧасы = 0;

	// Resource 1: Senior Developer
	Ресурс1 = Объект.Ресурсы.Добавить();
	Ресурс1.ПроектИД = "RES-001";
	Ресурс1.ИмяРесурса = "Иванов Иван";
	Ресурс1.ТипРесурса = "Разработчик";
	Ресурс1.Роль = "Senior Developer";
	Ресурс1.СтоимостьЧаса = 2000;
	Ресурс1.ЗагрузкаЧасов = 160;
	Ресурс1.Доступность = 100;
	СтоимостьРесурса1 = 2000 * 160;
	ОбщаяСтоимость = ОбщаяСтоимость + СтоимостьРесурса1;
	ОбщиеЧасы = ОбщиеЧасы + 160;

	// Resource 2: Middle Developer
	Ресурс2 = Объект.Ресурсы.Добавить();
	Ресурс2.ПроектИД = "RES-001";
	Ресурс2.ИмяРесурса = "Петров Петр";
	Ресурс2.ТипРесурса = "Разработчик";
	Ресурс2.Роль = "Middle Developer";
	Ресурс2.СтоимостьЧаса = 1500;
	Ресурс2.ЗагрузкаЧасов = 160;
	Ресурс2.Доступность = 80;
	СтоимостьРесурса2 = 1500 * 160;
	ОбщаяСтоимость = ОбщаяСтоимость + СтоимостьРесурса2;
	ОбщиеЧасы = ОбщиеЧасы + 160;

	// Resource 3: QA Engineer
	Ресурс3 = Объект.Ресурсы.Добавить();
	Ресурс3.ПроектИД = "RES-001";
	Ресурс3.ИмяРесурса = "Сидорова Анна";
	Ресурс3.ТипРесурса = "Тестировщик";
	Ресурс3.Роль = "QA Engineer";
	Ресурс3.СтоимостьЧаса = 1200;
	Ресурс3.ЗагрузкаЧасов = 80;
	Ресурс3.Доступность = 100;
	СтоимостьРесурса3 = 1200 * 80;
	ОбщаяСтоимость = ОбщаяСтоимость + СтоимостьРесурса3;
	ОбщиеЧасы = ОбщиеЧасы + 80;

	// Verify calculations
	ОжидаемаяСтоимость = (2000 * 160) + (1500 * 160) + (1200 * 80);
	Если ОбщаяСтоимость <> ОжидаемаяСтоимость Тогда
		ВызватьИсключение СтрШаблон(
			"Resource cost calculation error: expected %1, got %2",
			ОжидаемаяСтоимость, ОбщаяСтоимость
		);
	КонецЕсли;

	Если ОбщиеЧасы <> 400 Тогда
		ВызватьИсключение СтрШаблон("Total hours error: expected 400, got %1", ОбщиеЧасы);
	КонецЕсли;

	Если Объект.Ресурсы.Количество() <> 3 Тогда
		ВызватьИсключение СтрШаблон("Resource count error: expected 3, got %1", Объект.Ресурсы.Количество());
	КонецЕсли;

	// Update project with calculations
	Проект.ФактическиеЗатраты = ОбщаяСтоимость;
	Проект.КоличествоУчастников = 3;

	// Verify budget doesn't exceed
	Если Проект.ФактическиеЗатраты > Проект.Бюджет Тогда
		ВызватьИсключение СтрШаблон(
			"Budget exceeded: budget %1, actual %2",
			Проект.Бюджет, Проект.ФактическиеЗатраты
		);
	КонецЕсли;

КонецПроцедуры

// ========================================================================
// Test 4: Export/Import Data Validation
// ========================================================================
&НаСервере
Процедура Тест_ExportImportData() Экспорт
	// Test data export/import cycle

	// Create test data
	Проект = Объект.Проекты.Добавить();
	Проект.ПроектИД = "EXP-001";
	Проект.Код = "EXP-001";
	Проект.Название = "Export Test Project";
	Проект.Статус = "Активный";

	Задача = Объект.ЗадачиПроекта.Добавить();
	Задача.ПроектИД = "EXP-001";
	Задача.Название = "Export Test Task";
	Задача.Статус = "Новая";

	// Store original counts
	ИсходноеКоличествоПроектов = Объект.Проекты.Количество();
	ИсходноеКоличествоЗадач = Объект.ЗадачиПроекта.Количество();

	Если ИсходноеКоличествоПроектов <> 1 Тогда
		ВызватьИсключение "Initial project count should be 1";
	КонецЕсли;

	Если ИсходноеКоличествоЗадач <> 1 Тогда
		ВызватьИсключение "Initial task count should be 1";
	КонецЕсли;

	// Test that data structure is intact
	Если Объект.Проекты[0].Код <> "EXP-001" Тогда
		ВызватьИсключение "Project code mismatch after setup";
	КонецЕсли;

	Если Объект.ЗадачиПроекта[0].ПроектИД <> "EXP-001" Тогда
		ВызватьИсключение "Task project ID mismatch";
	КонецЕсли;

КонецПроцедуры

// ========================================================================
// Test 5: Validation Rules
// ========================================================================
&НаСервере
Процедура Тест_ValidationRules() Экспорт
	// Test various validation scenarios

	// Test 1: Project with valid data
	Проект = Объект.Проекты.Добавить();
	Проект.ПроектИД = "VAL-001";
	Проект.Код = "VAL-001";
	Проект.Название = "Validation Test";
	Проект.Статус = "Активный";
	Проект.Приоритет = "Высокий";
	Проект.Бюджет = 100000;
	Проект.ФактическиеЗатраты = 50000;

	// Verify budget is not exceeded
	Если Проект.ФактическиеЗатраты > Проект.Бюджет Тогда
		ВызватьИсключение "Budget exceeded validation failed";
	КонецЕсли;

	// Test 2: Progress percentage validation (0-100)
	Проект.Прогресс = 75;
	Если Проект.Прогресс < 0 ИЛИ Проект.Прогресс > 100 Тогда
		ВызватьИсключение СтрШаблон("Progress out of range: %1", Проект.Прогресс);
	КонецЕсли;

	// Test 3: Task validation
	Задача = Объект.ЗадачиПроекта.Добавить();
	Задача.ПроектИД = "VAL-001";
	Задача.Название = "Test Task";
	Задача.ПлановоеВремя = 40;
	Задача.ФактическоеВремя = 30;
	Задача.ЗавершеноПроцентов = 75;

	// Verify actual time doesn't exceed planned time significantly
	Если Задача.ФактическоеВремя > Задача.ПлановоеВремя * 2 Тогда
		ВызватьИсключение "Task time validation: actual time is too high";
	КонецЕсли;

	// Verify progress percentage is valid
	Если Задача.ЗавершеноПроцентов < 0 ИЛИ Задача.ЗавершеноПроцентов > 100 Тогда
		ВызватьИсключение "Task progress out of range";
	КонецЕсли;

	// Test 4: Resource availability validation
	Ресурс = Объект.Ресурсы.Добавить();
	Ресурс.ПроектИД = "VAL-001";
	Ресурс.ИмяРесурса = "Test Resource";
	Ресурс.Доступность = 100;

	Если Ресурс.Доступность < 0 ИЛИ Ресурс.Доступность > 100 Тогда
		ВызватьИсключение "Resource availability out of range";
	КонецЕсли;

КонецПроцедуры

// ========================================================================
// Test 6: Statistics Calculation
// ========================================================================
&НаСервере
Процедура Тест_StatisticsCalculation() Экспорт
	// Test complex statistics across multiple projects

	// Project 1: Active with tasks
	Проект1 = Объект.Проекты.Добавить();
	Проект1.ПроектИД = "STAT-001";
	Проект1.Название = "Project 1";
	Проект1.Статус = "Активный";
	Проект1.Бюджет = 500000;
	Проект1.ФактическиеЗатраты = 250000;
	Проект1.Прогресс = 50;
	Проект1.КоличествоЗадач = 10;

	// Project 2: Completed
	Проект2 = Объект.Проекты.Добавить();
	Проект2.ПроектИД = "STAT-002";
	Проект2.Название = "Project 2";
	Проект2.Статус = "Завершен";
	Проект2.Бюджет = 300000;
	Проект2.ФактическиеЗатраты = 280000;
	Проект2.Прогресс = 100;
	Проект2.КоличествоЗадач = 5;

	// Project 3: Planning
	Проект3 = Объект.Проекты.Добавить();
	Проект3.ПроектИД = "STAT-003";
	Проект3.Название = "Project 3";
	Проект3.Статус = "Планирование";
	Проект3.Бюджет = 200000;
	Проект3.ФактическиеЗатраты = 0;
	Проект3.Прогресс = 0;
	Проект3.КоличествоЗадач = 3;

	// Calculate statistics
	ВсегоПроектов = Объект.Проекты.Количество();
	ОбщийБюджет = 0;
	ОбщиеЗатраты = 0;
	СреднийПрогресс = 0;
	ВсегоЗадач = 0;

	Для Каждого Проект Из Объект.Проекты Цикл
		ОбщийБюджет = ОбщийБюджет + Проект.Бюджет;
		ОбщиеЗатраты = ОбщиеЗатраты + Проект.ФактическиеЗатраты;
		СреднийПрогресс = СреднийПрогресс + Проект.Прогресс;
		ВсегоЗадач = ВсегоЗадач + Проект.КоличествоЗадач;
	КонецЦикла;

	СреднийПрогресс = СреднийПрогресс / ВсегоПроектов;

	// Verify calculations
	Если ВсегоПроектов <> 3 Тогда
		ВызватьИсключение СтрШаблон("Project count error: expected 3, got %1", ВсегоПроектов);
	КонецЕсли;

	Если ОбщийБюджет <> 1000000 Тогда
		ВызватьИсключение СтрШаблон("Total budget error: expected 1000000, got %1", ОбщийБюджет);
	КонецЕсли;

	Если ОбщиеЗатраты <> 530000 Тогда
		ВызватьИсключение СтрШаблон("Total costs error: expected 530000, got %1", ОбщиеЗатраты);
	КонецЕсли;

	Если ВсегоЗадач <> 18 Тогда
		ВызватьИсключение СтрШаблон("Total tasks error: expected 18, got %1", ВсегоЗадач);
	КонецЕсли;

	// Average progress = (50 + 100 + 0) / 3 = 50
	Если СреднийПрогресс <> 50 Тогда
		ВызватьИсключение СтрШаблон("Average progress error: expected 50, got %1", СреднийПрогресс);
	КонецЕсли;

	// Calculate budget efficiency
	БюджетнаяЭффективность = (ОбщийБюджет - ОбщиеЗатраты) / ОбщийБюджет * 100;
	ОжидаемаяЭффективность = 47; // (1000000 - 530000) / 1000000 * 100 = 47%

	Если БюджетнаяЭффективность <> ОжидаемаяЭффективность Тогда
		ВызватьИсключение СтрШаблон(
			"Budget efficiency error: expected %1%%, got %2%%",
			ОжидаемаяЭффективность, БюджетнаяЭффективность
		);
	КонецЕсли;

КонецПроцедуры
