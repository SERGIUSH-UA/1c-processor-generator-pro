// ========================================================================
// CORRECTED Procedural Tests for УправлениеПроектами
// ========================================================================
//
// ⚠️ IMPORTANT: These tests call EXPORTED procedures from ObjectModule.bsl
// All test procedures must be marked with &НаСервере Экспорт
//
// Available exported procedures:
// - ЭкспортироватьДанныеВJSON() Экспорт
// - ЭкспортироватьДанныеВXML() Экспорт
// - ИмпортироватьДанныеИзJSON(JSONСтрока) Экспорт
// - ИмпортироватьДанныеИзXML(XMLСтрока) Экспорт
// - ПроверитьКорректностьДанных() Экспорт
// - РассчитатьСтатистикуПроектов() Экспорт
// - НайтиПросроченныеЗадачиПроекта() Экспорт
// - НайтиПерегруженныеРесурсы() Экспорт

&НаСервере
Процедура Тест_ExportImportCycle() Экспорт
	// Test: Export to JSON, then import back

	// 1. Create test data
	НоваяСтрока = Объект.Проекты.Добавить();
	НоваяСтрока.ПроектИД = "CYCLE-001";
	НоваяСтрока.Код = "C001";
	НоваяСтрока.Название = "Export-Import Test";
	НоваяСтрока.Статус = "Активен";

	// 2. Export to JSON
	JSONСтрока = Объект.ЭкспортироватьДанныеВJSON();

	Если ПустаяСтрока(JSONСтрока) Тогда
		ВызватьИсключение "Export to JSON failed - empty result";
	КонецЕсли;

	// 3. Clear data
	Объект.Проекты.Очистить();

	Если Объект.Проекты.Количество() <> 0 Тогда
		ВызватьИсключение "Failed to clear projects table";
	КонецЕсли;

	// 4. Import back from JSON
	Объект.ИмпортироватьДанныеИзJSON(JSONСтрока);

	// 5. Verify data restored
	Если Объект.Проекты.Количество() <> 1 Тогда
		ВызватьИсключение "Import failed - expected 1 project, got " + Объект.Проекты.Количество();
	КонецЕсли;

	ВосстановленныйПроект = Объект.Проекты.Получить(0);
	Если ВосстановленныйПроект.ПроектИД <> "CYCLE-001" Тогда
		ВызватьИсключение "Imported project ID mismatch";
	КонецЕсли;

	Сообщить("✅ Export-Import cycle test passed");

КонецПроцедуры

&НаСервере
Процедура Тест_ValidationRules() Экспорт
	// Test: Data validation logic

	// 1. Add valid project
	ВалидныйПроект = Объект.Проекты.Добавить();
	ВалидныйПроект.ПроектИД = "VAL-001";
	ВалидныйПроект.Код = "V001";
	ВалидныйПроект.Название = "Valid Project";
	ВалидныйПроект.Статус = "Активен";
	ВалидныйПроект.ДатаНачала = ТекущаяДата();
	ВалидныйПроект.ДатаОкончания = ТекущаяДата() + 86400; // +1 day

	// 2. Add invalid project (end date before start date)
	НевалидныйПроект = Объект.Проекты.Добавить();
	НевалидныйПроект.ПроектИД = "VAL-002";
	НевалидныйПроект.Код = "V002";
	НевалидныйПроект.Название = "Invalid Project";
	НевалидныйПроект.Статус = "Активен";
	НевалидныйПроект.ДатаНачала = ТекущаяДата();
	НевалидныйПроект.ДатаОкончания = ТекущаяДата() - 86400; // -1 day (invalid!)

	// 3. Run validation
	Ошибки = Объект.ПроверитьКорректностьДанных();

	// 4. Verify we got validation errors
	Если Ошибки.Количество() = 0 Тогда
		ВызватьИсключение "Validation should detect invalid project";
	КонецЕсли;

	Сообщить("✅ Validation rules test passed - detected " + Ошибки.Количество() + " error(s)");

КонецПроцедуры

&НаСервере
Процедура Тест_StatisticsCalculation() Экспорт
	// Test: Statistics calculation

	// 1. Create test projects
	Для Индекс = 1 По 5 Цикл
		НовыйПроект = Объект.Проекты.Добавить();
		НовыйПроект.ПроектИД = "STAT-" + Формат(Индекс, "ЧЦ=3; ЧВН=");
		НовыйПроект.Код = "S" + Формат(Индекс, "ЧЦ=3; ЧН=0; ЧВН=");
		НовыйПроект.Название = "Statistics Project " + Индекс;
		НовыйПроект.Статус = ?(Индекс > 3, "Закрыт", "Активен");
	КонецЦикла;

	Если Объект.Проекты.Количество() <> 5 Тогда
		ВызватьИсключение "Failed to create 5 projects";
	КонецЕсли;

	// 2. Calculate statistics
	Статистика = Объект.РассчитатьСтатистикуПроектов();

	// 3. Verify statistics object returned
	Если Статистика = Неопределено Тогда
		ВызватьИсключение "Statistics calculation returned Undefined";
	КонецЕсли;

	// 4. Verify statistics structure (ValueTable expected)
	Попытка
		КоличествоСтрок = Статистика.Количество();
		Сообщить("Statistics has " + КоличествоСтрок + " row(s)");
	Исключение
		ВызватьИсключение "Statistics result is not a table: " + ОписаниеОшибки();
	КонецПопытки;

	Сообщить("✅ Statistics calculation test passed");

КонецПроцедуры
