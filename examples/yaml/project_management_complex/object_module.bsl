#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ПрограммныйИнтерфейс

// ============================================================================
// ПУБЛИЧНЫЙ API - ЭКСПОРТ/ИМПОРТ ДАННЫХ
// ============================================================================

Функция ЭкспортироватьДанныеВJSON() Экспорт
	// Експорт всіх даних у форматі JSON
	ДанныеДляЭкспорта = Новый Структура;

	// Експорт проектів
	МассивПроектов = Новый Массив;
	Для Каждого СтрокаПроекта Из Проекты Цикл
		Проект = ПреобразоватьПроектВСтруктуру(СтрокаПроекта);
		МассивПроектов.Добавить(Проект);
	КонецЦикла;
	ДанныеДляЭкспорта.Вставить("projects", МассивПроектов);

	// Експорт задач
	МассивЗадач = Новый Массив;
	Для Каждого СтрокаЗадачиПроекта Из ЗадачиПроекта Цикл
		Задача = ПреобразоватьЗадачуВСтруктуру(СтрокаЗадачиПроекта);
		МассивЗадач.Добавить(Задача);
	КонецЦикла;
	ДанныеДляЭкспорта.Вставить("tasks", МассивЗадач);

	// Експорт ресурсів
	МассивРесурсов = Новый Массив;
	Для Каждого СтрокаРесурса Из Ресурсы Цикл
		Ресурс = ПреобразоватьРесурсВСтруктуру(СтрокаРесурса);
		МассивРесурсов.Добавить(Ресурс);
	КонецЦикла;
	ДанныеДляЭкспорта.Вставить("resources", МассивРесурсов);

	// Метадані експорту
	Метаданные = Новый Структура;
	Метаданные.Вставить("export_date", ТекущаяДата());
	Метаданные.Вставить("version", ВерсияДанных);
	Метаданные.Вставить("total_projects", Проекты.Количество());
	Метаданные.Вставить("total_tasks", ЗадачиПроекта.Количество());
	Метаданные.Вставить("total_resources", Ресурсы.Количество());
	ДанныеДляЭкспорта.Вставить("metadata", Метаданные);

	// Конвертація в JSON
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку();
	ЗаписатьJSON(ЗаписьJSON, ДанныеДляЭкспорта);
	JSONСтрока = ЗаписьJSON.Закрыть();

	Возврат JSONСтрока;
КонецФункции

Функция ЭкспортироватьДанныеВXML() Экспорт
	// Експорт у форматі XML
	XMLЗапись = Новый ЗаписьXML;
	XMLЗапись.УстановитьСтроку();

	XMLЗапись.ЗаписатьНачалоЭлемента("ProjectManagementData");

	// Експорт проектів
	XMLЗапись.ЗаписатьНачалоЭлемента("Projects");
	Для Каждого СтрокаПроекта Из Проекты Цикл
		ЗаписатьПроектВXML(XMLЗапись, СтрокаПроекта);
	КонецЦикла;
	XMLЗапись.ЗаписатьКонецЭлемента(); // Projects

	// Експорт задач
	XMLЗапись.ЗаписатьНачалоЭлемента("Tasks");
	Для Каждого СтрокаЗадачиПроекта Из ЗадачиПроекта Цикл
		ЗаписатьЗадачуВXML(XMLЗапись, СтрокаЗадачиПроекта);
	КонецЦикла;
	XMLЗапись.ЗаписатьКонецЭлемента(); // Tasks

	// Експорт ресурсів
	XMLЗапись.ЗаписатьНачалоЭлемента("Resources");
	Для Каждого СтрокаРесурса Из Ресурсы Цикл
		ЗаписатьРесурсВXML(XMLЗапись, СтрокаРесурса);
	КонецЦикла;
	XMLЗапись.ЗаписатьКонецЭлемента(); // Resources

	XMLЗапись.ЗаписатьКонецЭлемента(); // ProjectManagementData

	XMLСтрока = XMLЗапись.Закрыть();

	Возврат XMLСтрока;
КонецФункции

Процедура ИмпортироватьДанныеИзJSON(JSONСтрока) Экспорт
	// Імпорт даних з JSON
	ЧтениеJSON = Новый ЧтениеJSON;
	ЧтениеJSON.УстановитьСтроку(JSONСтрока);
	ДанныеДляИмпорта = ПрочитатьJSON(ЧтениеJSON);
	ЧтениеJSON.Закрыть();

	// Очищення поточних даних
	Проекты.Очистить();
	ЗадачиПроекта.Очистить();
	Ресурсы.Очистить();

	// Імпорт проектів
	Если ДанныеДляИмпорта.Свойство("projects") Тогда
		Для Каждого ДанныеПроекта Из ДанныеДляИмпорта.projects Цикл
			ЗагрузитьПроектИзСтруктуры(ДанныеПроекта);
		КонецЦикла;
	КонецЕсли;

	// Імпорт задач
	Если ДанныеДляИмпорта.Свойство("tasks") Тогда
		Для Каждого ДанныеЗадачиПроекта Из ДанныеДляИмпорта.tasks Цикл
			ЗагрузитьЗадачуИзСтруктуры(ДанныеЗадачиПроекта);
		КонецЦикла;
	КонецЕсли;

	// Імпорт ресурсів
	Если ДанныеДляИмпорта.Свойство("resources") Тогда
		Для Каждого ДанныеРесурса Из ДанныеДляИмпорта.resources Цикл
			ЗагрузитьРесурсИзСтруктуры(ДанныеРесурса);
		КонецЦикла;
	КонецЕсли;
КонецПроцедуры

Процедура ИмпортироватьДанныеИзXML(XMLСтрока) Экспорт
	// Імпорт даних з XML
	ЧтениеXML = Новый ЧтениеXML;
	ЧтениеXML.УстановитьСтроку(XMLСтрока);

	// Очищення поточних даних
	Проекты.Очистить();
	ЗадачиПроекта.Очистить();
	Ресурсы.Очистить();

	Пока ЧтениеXML.Прочитать() Цикл
		Если ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента Тогда
			Если ЧтениеXML.Имя = "Project" Тогда
				ЗагрузитьПроектИзXML(ЧтениеXML);
			ИначеЕсли ЧтениеXML.Имя = "Task" Тогда
				ЗагрузитьЗадачуИзXML(ЧтениеXML);
			ИначеЕсли ЧтениеXML.Имя = "Resource" Тогда
				ЗагрузитьРесурсИзXML(ЧтениеXML);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;

	ЧтениеXML.Закрыть();
КонецПроцедуры

// ============================================================================
// ВАЛІДАЦІЯ ДАНИХ
// ============================================================================

Функция ПроверитьКорректностьДанных() Экспорт
	// Комплексна валідація всіх даних
	Ошибки = Новый Массив;

	// Перевірка проектів
	Для Каждого СтрокаПроекта Из Проекты Цикл
		ОшибкиПроекта = ПроверитьПроект(СтрокаПроекта);
		Для Каждого Ошибка Из ОшибкиПроекта Цикл
			Ошибки.Добавить(Ошибка);
		КонецЦикла;
	КонецЦикла;

	// Перевірка задач
	Для Каждого СтрокаЗадачиПроекта Из ЗадачиПроекта Цикл
		ОшибкиЗадачиПроекта = ПроверитьЗадачу(СтрокаЗадачиПроекта);
		Для Каждого Ошибка Из ОшибкиЗадачиПроекта Цикл
			Ошибки.Добавить(Ошибка);
		КонецЦикла;
	КонецЦикла;

	// Перевірка ресурсів
	Для Каждого СтрокаРесурса Из Ресурсы Цикл
		ОшибкиРесурса = ПроверитьРесурс(СтрокаРесурса);
		Для Каждого Ошибка Из ОшибкиРесурса Цикл
			Ошибки.Добавить(Ошибка);
		КонецЦикла;
	КонецЦикла;

	Возврат Ошибки;
КонецФункции

Функция ПроверитьПроект(СтрокаПроекта) Экспорт
	Ошибки = Новый Массив;

	// Обов'язкові поля
	Если НЕ ЗначениеЗаполнено(СтрокаПроекта.Название) Тогда
		Ошибки.Добавить(СтрШаблон("Проект %1: не заполнено название", СтрокаПроекта.Код));
	КонецЕсли;

	Если НЕ ЗначениеЗаполнено(СтрокаПроекта.Код) Тогда
		Ошибки.Добавить(СтрШаблон("Проект ""%1"": не заполнен код", СтрокаПроекта.Название));
	КонецЕсли;

	// Перевірка дат
	Если ЗначениеЗаполнено(СтрокаПроекта.ДатаНачала) И ЗначениеЗаполнено(СтрокаПроекта.ДатаОкончания) Тогда
		Если СтрокаПроекта.ДатаНачала > СтрокаПроекта.ДатаОкончания Тогда
			Ошибки.Добавить(СтрШаблон("Проект ""%1"": дата начала больше даты окончания", СтрокаПроекта.Название));
		КонецЕсли;
	КонецЕсли;

	// Перевірка бюджету
	Если СтрокаПроекта.Бюджет < 0 Тогда
		Ошибки.Добавить(СтрШаблон("Проект ""%1"": бюджет не может быть отрицательным", СтрокаПроекта.Название));
	КонецЕсли;

	Если СтрокаПроекта.ФактическиеЗатраты < 0 Тогда
		Ошибки.Добавить(СтрШаблон("Проект ""%1"": фактические затраты не могут быть отрицательными", СтрокаПроекта.Название));
	КонецЕсли;

	// Перевірка прогресу
	Если СтрокаПроекта.Прогресс < 0 ИЛИ СтрокаПроекта.Прогресс > 100 Тогда
		Ошибки.Добавить(СтрШаблон("Проект ""%1"": прогресс должен быть от 0 до 100", СтрокаПроекта.Название));
	КонецЕсли;

	Возврат Ошибки;
КонецФункции

Функция ПроверитьЗадачу(СтрокаЗадачиПроекта) Экспорт
	Ошибки = Новый Массив;

	// Обов'язкові поля
	Если НЕ ЗначениеЗаполнено(СтрокаЗадачиПроекта.Название) Тогда
		Ошибки.Добавить("Задача: не заполнено название");
	КонецЕсли;

	// Перевірка прив'язки до проекту
	Если ЗначениеЗаполнено(СтрокаЗадачиПроекта.ПроектИД) Тогда
		СтрокиПроекта = Проекты.НайтиСтроки(Новый Структура("ПроектИД", СтрокаЗадачиПроекта.ПроектИД));
		Если СтрокиПроекта.Количество() = 0 Тогда
			Ошибки.Добавить(СтрШаблон("Задача ""%1"": проект с ID %2 не найден", СтрокаЗадачиПроекта.Название, СтрокаЗадачиПроекта.ПроектИД));
		КонецЕсли;
	КонецЕсли;

	// Перевірка дат
	Если ЗначениеЗаполнено(СтрокаЗадачиПроекта.ДатаНачала) И ЗначениеЗаполнено(СтрокаЗадачиПроекта.ДатаОкончания) Тогда
		Если СтрокаЗадачиПроекта.ДатаНачала > СтрокаЗадачиПроекта.ДатаОкончания Тогда
			Ошибки.Добавить(СтрШаблон("Задача ""%1"": дата начала больше даты окончания", СтрокаЗадачиПроекта.Название));
		КонецЕсли;
	КонецЕсли;

	// Перевірка часу
	Если СтрокаЗадачиПроекта.ПлановоеВремя < 0 Тогда
		Ошибки.Добавить(СтрШаблон("Задача ""%1"": плановое время не может быть отрицательным", СтрокаЗадачиПроекта.Название));
	КонецЕсли;

	Если СтрокаЗадачиПроекта.ФактическоеВремя < 0 Тогда
		Ошибки.Добавить(СтрШаблон("Задача ""%1"": фактическое время не может быть отрицательным", СтрокаЗадачиПроекта.Название));
	КонецЕсли;

	// Перевірка відсотка завершення
	Если СтрокаЗадачиПроекта.ЗавершеноПроцентов < 0 ИЛИ СтрокаЗадачиПроекта.ЗавершеноПроцентов > 100 Тогда
		Ошибки.Добавить(СтрШаблон("Задача ""%1"": процент завершения должен быть от 0 до 100", СтрокаЗадачиПроекта.Название));
	КонецЕсли;

	Возврат Ошибки;
КонецФункции

Функция ПроверитьРесурс(СтрокаРесурса) Экспорт
	Ошибки = Новый Массив;

	// Обов'язкові поля
	Если НЕ ЗначениеЗаполнено(СтрокаРесурса.ИмяРесурса) Тогда
		Ошибки.Добавить("Ресурс: не заполнено имя");
	КонецЕсли;

	// Перевірка доступності
	Если СтрокаРесурса.Доступность < 0 ИЛИ СтрокаРесурса.Доступность > 100 Тогда
		Ошибки.Добавить(СтрШаблон("Ресурс ""%1"": доступность должна быть от 0 до 100", СтрокаРесурса.ИмяРесурса));
	КонецЕсли;

	// Перевірка вартості
	Если СтрокаРесурса.СтоимостьЧаса < 0 Тогда
		Ошибки.Добавить(СтрШаблон("Ресурс ""%1"": стоимость часа не может быть отрицательной", СтрокаРесурса.ИмяРесурса));
	КонецЕсли;

	// Перевірка завантаження
	Если СтрокаРесурса.ЗагрузкаЧасов < 0 Тогда
		Ошибки.Добавить(СтрШаблон("Ресурс ""%1"": загрузка не может быть отрицательной", СтрокаРесурса.ИмяРесурса));
	КонецЕсли;

	// Перевірка email
	Если ЗначениеЗаполнено(СтрокаРесурса.Email) И НЕ ПроверитьEmailАдрес(СтрокаРесурса.Email) Тогда
		Ошибки.Добавить(СтрШаблон("Ресурс ""%1"": некорректный email адрес", СтрокаРесурса.ИмяРесурса));
	КонецЕсли;

	Возврат Ошибки;
КонецФункции

// ============================================================================
// РОЗРАХУНКИ ТА АНАЛІТИКА
// ============================================================================

Функция РассчитатьСтатистикуПроектов() Экспорт
	// Розрахунок статистики по всіх проектах
	Статистика = Новый Структура;

	// Загальна статистика
	Статистика.Вставить("ВсегоПроектов", Проекты.Количество());
	Статистика.Вставить("ВсегоЗадач", ЗадачиПроекта.Количество());
	Статистика.Вставить("ВсегоРесурсов", Ресурсы.Количество());

	// Статистика по статусах проектів
	АктивныхПроектов = 0;
	ЗавершенныхПроектов = 0;
	Для Каждого СтрокаПроекта Из Проекты Цикл
		Если СтрокаПроекта.Статус = "Активный" Тогда
			АктивныхПроектов = АктивныхПроектов + 1;
		ИначеЕсли СтрокаПроекта.Статус = "Завершен" Тогда
			ЗавершенныхПроектов = ЗавершенныхПроектов + 1;
		КонецЕсли;
	КонецЦикла;
	Статистика.Вставить("АктивныхПроектов", АктивныхПроектов);
	Статистика.Вставить("ЗавершенныхПроектов", ЗавершенныхПроектов);

	// Фінансова статистика
	ОбщийБюджет = 0;
	ОбщиеЗатраты = 0;
	Для Каждого СтрокаПроекта Из Проекты Цикл
		ОбщийБюджет = ОбщийБюджет + СтрокаПроекта.Бюджет;
		ОбщиеЗатраты = ОбщиеЗатраты + СтрокаПроекта.ФактическиеЗатраты;
	КонецЦикла;
	Статистика.Вставить("ОбщийБюджет", ОбщийБюджет);
	Статистика.Вставить("ОбщиеЗатраты", ОбщиеЗатраты);
	Статистика.Вставить("Экономия", ОбщийБюджет - ОбщиеЗатраты);

	// Середній прогрес
	СуммаПрогресса = 0;
	Для Каждого СтрокаПроекта Из Проекты Цикл
		СуммаПрогресса = СуммаПрогресса + СтрокаПроекта.Прогресс;
	КонецЦикла;
	СреднийПрогресс = ?(Проекты.Количество() > 0, СуммаПрогресса / Проекты.Количество(), 0);
	Статистика.Вставить("СреднийПрогресс", СреднийПрогресс);

	Возврат Статистика;
КонецФункции

Функция РассчитатьПрогрессПроекта(ПроектИД) Экспорт
	// Розрахунок прогресу проекту на основі задач
	СтрокиЗадач = ЗадачиПроекта.НайтиСтроки(Новый Структура("ПроектИД", ПроектИД));

	Если СтрокиЗадач.Количество() = 0 Тогда
		Возврат 0;
	КонецЕсли;

	СуммаПрогресса = 0;
	Для Каждого СтрокаЗадачиПроекта Из СтрокиЗадач Цикл
		СуммаПрогресса = СуммаПрогресса + СтрокаЗадачиПроекта.ЗавершеноПроцентов;
	КонецЦикла;

	СреднийПрогресс = СуммаПрогресса / СтрокиЗадач.Количество();

	Возврат СреднийПрогресс;
КонецФункции

Функция РассчитатьФактическиеЗатратыПроекта(ПроектИД) Экспорт
	// Розрахунок фактичних витрат на основі ресурсів та їх завантаження
	СтрокиРесурсов = Ресурсы.НайтиСтроки(Новый Структура("ПроектИД", ПроектИД));

	ОбщиеЗатраты = 0;
	Для Каждого СтрокаРесурса Из СтрокиРесурсов Цикл
		ЗатратыРесурса = СтрокаРесурса.ЗагрузкаЧасов * СтрокаРесурса.СтоимостьЧаса;
		ОбщиеЗатраты = ОбщиеЗатраты + ЗатратыРесурса;
	КонецЦикла;

	Возврат ОбщиеЗатраты;
КонецФункции

Функция НайтиПросроченныеЗадачиПроекта() Экспорт
	// Пошук прострочених задач
	ПросроченныеЗадачиПроекта = Новый Массив;

	ТекущаяДатаБезВремени = НачалоДня(ТекущаяДата());

	Для Каждого СтрокаЗадачиПроекта Из ЗадачиПроекта Цикл
		Если ЗначениеЗаполнено(СтрокаЗадачиПроекта.ДатаОкончания) Тогда
			Если СтрокаЗадачиПроекта.ДатаОкончания < ТекущаяДатаБезВремени И СтрокаЗадачиПроекта.Статус <> "Выполнена" И СтрокаЗадачиПроекта.Статус <> "Закрыта" Тогда
				ИнформацияОЗадаче = Новый Структура;
				ИнформацияОЗадаче.Вставить("ЗадачаИД", СтрокаЗадачиПроекта.ЗадачаИД);
				ИнформацияОЗадаче.Вставить("Название", СтрокаЗадачиПроекта.Название);
				ИнформацияОЗадаче.Вставить("ДатаОкончания", СтрокаЗадачиПроекта.ДатаОкончания);
				ИнформацияОЗадаче.Вставить("ДнейПросрочки", (ТекущаяДатаБезВремени - СтрокаЗадачиПроекта.ДатаОкончания) / 86400);

				ПросроченныеЗадачиПроекта.Добавить(ИнформацияОЗадаче);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;

	Возврат ПросроченныеЗадачиПроекта;
КонецФункции

Функция НайтиПерегруженныеРесурсы(МаксимальнаяЗагрузка = 160) Экспорт
	// Пошук перевантажених ресурсів
	ПерегруженныеРесурсы = Новый Массив;

	Для Каждого СтрокаРесурса Из Ресурсы Цикл
		Если СтрокаРесурса.ЗагрузкаЧасов > МаксимальнаяЗагрузка Тогда
			ИнформацияОРесурсе = Новый Структура;
			ИнформацияОРесурсе.Вставить("РесурсИД", СтрокаРесурса.РесурсИД);
			ИнформацияОРесурсе.Вставить("ИмяРесурса", СтрокаРесурса.ИмяРесурса);
			ИнформацияОРесурсе.Вставить("ЗагрузкаЧасов", СтрокаРесурса.ЗагрузкаЧасов);
			ИнформацияОРесурсе.Вставить("Перегрузка", СтрокаРесурса.ЗагрузкаЧасов - МаксимальнаяЗагрузка);

			ПерегруженныеРесурсы.Добавить(ИнформацияОРесурсе);
		КонецЕсли;
	КонецЦикла;

	Возврат ПерегруженныеРесурсы;
КонецФункции

// ============================================================================
// АВТОМАТИЧНІ РОЗРАХУНКИ
// ============================================================================

Процедура АвтоматическиОбновитьДанныеПроектов() Экспорт
	// Автоматичне оновлення даних всіх проектів
	Для Каждого СтрокаПроекта Из Проекты Цикл
		// Оновлення кількості задач
		СтрокиЗадач = ЗадачиПроекта.НайтиСтроки(Новый Структура("ПроектИД", СтрокаПроекта.ПроектИД));
		СтрокаПроекта.КоличествоЗадач = СтрокиЗадач.Количество();

		// Оновлення кількості учасників
		СтрокиРесурсов = Ресурсы.НайтиСтроки(Новый Структура("ПроектИД", СтрокаПроекта.ПроектИД));
		СтрокаПроекта.КоличествоУчастников = СтрокиРесурсов.Количество();

		// Оновлення прогресу
		СтрокаПроекта.Прогресс = РассчитатьПрогрессПроекта(СтрокаПроекта.ПроектИД);

		// Оновлення фактичних витрат
		СтрокаПроекта.ФактическиеЗатраты = РассчитатьФактическиеЗатратыПроекта(СтрокаПроекта.ПроектИД);
	КонецЦикла;
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// ============================================================================
// ПРИВАТНІ ФУНКЦІЇ - КОНВЕРТАЦІЯ ДАНИХ
// ============================================================================

Функция ПреобразоватьПроектВСтруктуру(СтрокаПроекта)
	Проект = Новый Структура;

	Для Каждого Колонка Из Проекты.Колонки Цикл
		Проект.Вставить(Колонка.Имя, СтрокаПроекта[Колонка.Имя]);
	КонецЦикла;

	Возврат Проект;
КонецФункции

Функция ПреобразоватьЗадачуВСтруктуру(СтрокаЗадачиПроекта)
	Задача = Новый Структура;

	Для Каждого Колонка Из ЗадачиПроекта.Колонки Цикл
		Задача.Вставить(Колонка.Имя, СтрокаЗадачиПроекта[Колонка.Имя]);
	КонецЦикла;

	Возврат Задача;
КонецФункции

Функция ПреобразоватьРесурсВСтруктуру(СтрокаРесурса)
	Ресурс = Новый Структура;

	Для Каждого Колонка Из Ресурсы.Колонки Цикл
		Ресурс.Вставить(Колонка.Имя, СтрокаРесурса[Колонка.Имя]);
	КонецЦикла;

	Возврат Ресурс;
КонецФункции

Процедура ЗаписатьПроектВXML(XMLЗапись, СтрокаПроекта)
	XMLЗапись.ЗаписатьНачалоЭлемента("Project");

	Для Каждого Колонка Из Проекты.Колонки Цикл
		XMLЗапись.ЗаписатьНачалоЭлемента(Колонка.Имя);
		XMLЗапись.ЗаписатьТекст(Строка(СтрокаПроекта[Колонка.Имя]));
		XMLЗапись.ЗаписатьКонецЭлемента();
	КонецЦикла;

	XMLЗапись.ЗаписатьКонецЭлемента(); // Project
КонецПроцедуры

Процедура ЗаписатьЗадачуВXML(XMLЗапись, СтрокаЗадачиПроекта)
	XMLЗапись.ЗаписатьНачалоЭлемента("Task");

	Для Каждого Колонка Из ЗадачиПроекта.Колонки Цикл
		XMLЗапись.ЗаписатьНачалоЭлемента(Колонка.Имя);
		XMLЗапись.ЗаписатьТекст(Строка(СтрокаЗадачиПроекта[Колонка.Имя]));
		XMLЗапись.ЗаписатьКонецЭлемента();
	КонецЦикла;

	XMLЗапись.ЗаписатьКонецЭлемента(); // Task
КонецПроцедуры

Процедура ЗаписатьРесурсВXML(XMLЗапись, СтрокаРесурса)
	XMLЗапись.ЗаписатьНачалоЭлемента("Resource");

	Для Каждого Колонка Из Ресурсы.Колонки Цикл
		XMLЗапись.ЗаписатьНачалоЭлемента(Колонка.Имя);
		XMLЗапись.ЗаписатьТекст(Строка(СтрокаРесурса[Колонка.Имя]));
		XMLЗапись.ЗаписатьКонецЭлемента();
	КонецЦикла;

	XMLЗапись.ЗаписатьКонецЭлемента(); // Resource
КонецПроцедуры

Процедура ЗагрузитьПроектИзСтруктуры(ДанныеПроекта)
	НоваяСтрока = Проекты.Добавить();

	Для Каждого Колонка Из Проекты.Колонки Цикл
		Если ДанныеПроекта.Свойство(Колонка.Имя) Тогда
			НоваяСтрока[Колонка.Имя] = ДанныеПроекта[Колонка.Имя];
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

Процедура ЗагрузитьЗадачуИзСтруктуры(ДанныеЗадачиПроекта)
	НоваяСтрока = ЗадачиПроекта.Добавить();

	Для Каждого Колонка Из ЗадачиПроекта.Колонки Цикл
		Если ДанныеЗадачиПроекта.Свойство(Колонка.Имя) Тогда
			НоваяСтрока[Колонка.Имя] = ДанныеЗадачиПроекта[Колонка.Имя];
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

Процедура ЗагрузитьРесурсИзСтруктуры(ДанныеРесурса)
	НоваяСтрока = Ресурсы.Добавить();

	Для Каждого Колонка Из Ресурсы.Колонки Цикл
		Если ДанныеРесурса.Свойство(Колонка.Имя) Тогда
			НоваяСтрока[Колонка.Имя] = ДанныеРесурса[Колонка.Имя];
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

Процедура ЗагрузитьПроектИзXML(ЧтениеXML)
	НоваяСтрока = Проекты.Добавить();

	Пока ЧтениеXML.Прочитать() Цикл
		Если ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента Тогда
			ИмяКолонки = ЧтениеXML.Имя;
			ЧтениеXML.Прочитать();
			Если ЧтениеXML.ТипУзла = ТипУзлаXML.Текст Тогда
				Попытка
					НоваяСтрока[ИмяКолонки] = ЧтениеXML.Значение;
				Исключение
					// Ігноруємо помилки конвертації
				КонецПопытки;
			КонецЕсли;
		ИначеЕсли ЧтениеXML.ТипУзла = ТипУзлаXML.КонецЭлемента И ЧтениеXML.Имя = "Project" Тогда
			Прервать;
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

Процедура ЗагрузитьЗадачуИзXML(ЧтениеXML)
	НоваяСтрока = ЗадачиПроекта.Добавить();

	Пока ЧтениеXML.Прочитать() Цикл
		Если ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента Тогда
			ИмяКолонки = ЧтениеXML.Имя;
			ЧтениеXML.Прочитать();
			Если ЧтениеXML.ТипУзла = ТипУзлаXML.Текст Тогда
				Попытка
					НоваяСтрока[ИмяКолонки] = ЧтениеXML.Значение;
				Исключение
					// Ігноруємо помилки конвертації
				КонецПопытки;
			КонецЕсли;
		ИначеЕсли ЧтениеXML.ТипУзла = ТипУзлаXML.КонецЭлемента И ЧтениеXML.Имя = "Task" Тогда
			Прервать;
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

Процедура ЗагрузитьРесурсИзXML(ЧтениеXML)
	НоваяСтрока = Ресурсы.Добавить();

	Пока ЧтениеXML.Прочитать() Цикл
		Если ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента Тогда
			ИмяКолонки = ЧтениеXML.Имя;
			ЧтениеXML.Прочитать();
			Если ЧтениеXML.ТипУзла = ТипУзлаXML.Текст Тогда
				Попытка
					НоваяСтрока[ИмяКолонки] = ЧтениеXML.Значение;
				Исключение
					// Ігноруємо помилки конвертації
				КонецПопытки;
			КонецЕсли;
		ИначеЕсли ЧтениеXML.ТипУзла = ТипУзлаXML.КонецЭлемента И ЧтениеXML.Имя = "Resource" Тогда
			Прервать;
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры

Функция ПроверитьEmailАдрес(EmailАдрес)
	// Проста валідація email
	Если НЕ ЗначениеЗаполнено(EmailАдрес) Тогда
		Возврат Истина; // Пустий email допустимий
	КонецЕсли;

	// Перевірка наявності @
	Если СтрНайти(EmailАдрес, "@") = 0 Тогда
		Возврат Ложь;
	КонецЕсли;

	// Перевірка наявності домену після @
	ПозицияСобаки = СтрНайти(EmailАдрес, "@");
	ДоменнаяЧасть = Сред(EmailАдрес, ПозицияСобаки + 1);

	Если НЕ ЗначениеЗаполнено(ДоменнаяЧасть) Тогда
		Возврат Ложь;
	КонецЕсли;

	// Перевірка наявності крапки в домені
	Если СтрНайти(ДоменнаяЧасть, ".") = 0 Тогда
		Возврат Ложь;
	КонецЕсли;

	Возврат Истина;
КонецФункции

#КонецОбласти

#КонецЕсли
