// ============================================================
// Web SPA Demo - Демонстрація патернів з WEB_PATTERNS.md
// ============================================================

// === ІНІЦІАЛІЗАЦІЯ ФОРМИ ===

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)

    // Завантажити головний HTML шаблон
    Макет = РеквизитФормыВЗначение("Объект").ПолучитьМакет("MainSPA");
    Объект.WebContent = Макет.ПолучитьТекст();

    // Ініціалізація
    Объект.ОбработаноСобытий = 0;
    Объект.ТекущийЭкран = "home";

КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)

    // Запустити перевірку черги подій (одноразово, перепідключається в обробнику)
    ПодключитьОбработчикОжидания("ПроверитьОчередьСобытий", 0.5, Истина);

КонецПроцедуры

// === EVENT LOOP ===

&НаКлиенте
Процедура ПроверитьОчередьСобытий()

    ОбработатьСобытияHTML(Неопределено);
    // Перепідключити для наступної перевірки
    ПодключитьОбработчикОжидания("ПроверитьОчередьСобытий", 0.5, Истина);

КонецПроцедуры

&НаКлиенте
Процедура WebViewПриНажатии(Элемент, ДанныеСобытия, СтандартнаяОбработка)

    СтандартнаяОбработка = Ложь;
    ОбработатьСобытияHTML(ДанныеСобытия);

КонецПроцедуры

// === ГОЛОВНИЙ ОБРОБНИК ПОДІЙ ===

&НаКлиенте
Процедура ОбработатьСобытияHTML(ДанныеСобытия)

    Документ = ЭтаФорма.Элементы.WebView.Документ;
    Если Документ = Неопределено Тогда
        Возврат;
    КонецЕсли;

    ОкноДокумента = Документ.defaultView;
    Если ОкноДокумента = Неопределено Тогда
        Возврат;
    КонецЕсли;

    // Fallback для прямих кліків по посиланнях
    Если ДанныеСобытия <> Неопределено И ЗначениеЗаполнено(ДанныеСобытия.Href) Тогда
        ОбработатьСсылку(ДанныеСобытия.Href, Документ);
    КонецЕсли;

    // Обробка черги подій з JavaScript
    Попытка
        КоличествоСобытий = ОкноДокумента.getQueueLength();
    Исключение
        Возврат; // Черга ще не ініціалізована
    КонецПопытки;

    Пока Объект.ОбработаноСобытий < КоличествоСобытий Цикл

        СтрокаJSON = ОкноДокумента.getEvent(Объект.ОбработаноСобытий);
        Если СтрокаJSON = Null Тогда
            Прервать;
        КонецЕсли;

        Событие = ПрочитатьДанныеИзJSON(СтрокаJSON);
        ОбработатьСобытие(Событие, Документ);

        Объект.ОбработаноСобытий = Объект.ОбработаноСобытий + 1;

    КонецЦикла;

КонецПроцедуры

// === РОУТЕР ===

&НаКлиенте
Процедура ОбработатьСобытие(Событие, Документ)

    Если Событие = Неопределено Тогда
        Возврат;
    КонецЕсли;

    Действие = Событие["action"];

    Если Действие = "navigate" Тогда
        ПерейтиНаЭкран(Событие["screen"], Документ);

    ИначеЕсли Действие = "search" Тогда
        ВыполнитьПоиск(Событие["query"], Документ);

    ИначеЕсли Действие = "select" Тогда
        ВыбратьКлиента(Событие["id"], Документ);

    ИначеЕсли Действие = "counter" Тогда
        ОбновитьСчетчик(Событие["delta"], Документ);

    ИначеЕсли Действие = "reset_counter" Тогда
        СброситьСчетчик(Документ);

    КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура ОбработатьСсылку(Href, Документ)

    // Розбір URL hash: http://any.link/#command__param
    Если СтрНайти(Href, "#") = 0 Тогда
        Возврат;
    КонецЕсли;

    Части = СтрРазделить(Href, "#");
    Если Части.Количество() < 2 Тогда
        Возврат;
    КонецЕсли;

    Команда = Части[1];

    // Розбір параметрів
    Если СтрНайти(Команда, "__") > 0 Тогда
        ЧастиКоманды = СтрРазделить(Команда, "__");
        Действие = ЧастиКоманды[0];
        Параметр = ЧастиКоманды[1];
    Иначе
        Действие = Команда;
        Параметр = "";
    КонецЕсли;

    // Роутинг
    Если Действие = "home" ИЛИ Действие = "clients" ИЛИ Действие = "about" Тогда
        ПерейтиНаЭкран(Действие, Документ);

    ИначеЕсли Действие = "client" И ЗначениеЗаполнено(Параметр) Тогда
        ВыбратьКлиента(Параметр, Документ);

    КонецЕсли;

КонецПроцедуры

// === НАВІГАЦІЯ ===

&НаКлиенте
Процедура ПерейтиНаЭкран(ИмяЭкрана, Документ)

    // Сховати всі екрани (через класи, не inline style!)
    УдалитьКласс(Документ, "#screen-home", "active");
    УдалитьКласс(Документ, "#screen-clients", "active");
    УдалитьКласс(Документ, "#screen-about", "active");

    // Показати потрібний
    ДобавитьКласс(Документ, "#screen-" + ИмяЭкрана, "active");

    // Оновити активний пункт меню
    УдалитьКласс(Документ, "#nav-home", "active");
    УдалитьКласс(Документ, "#nav-clients", "active");
    УдалитьКласс(Документ, "#nav-about", "active");
    ДобавитьКласс(Документ, "#nav-" + ИмяЭкрана, "active");

    // Ініціалізація екрану
    Если ИмяЭкрана = "clients" Тогда
        ЗагрузитьСписокКлиентов(Документ);
    КонецЕсли;

    Объект.ТекущийЭкран = ИмяЭкрана;

КонецПроцедуры

// === БІЗНЕС-ЛОГІКА ===

&НаКлиенте
Процедура ЗагрузитьСписокКлиентов(Документ)

    // Демо-дані (в реальності - виклик сервера)
    Клиенты = ПолучитьДемоКлиентов();

    HTML = "";
    Для Каждого Клиент Из Клиенты Цикл
        HTML = HTML + СформироватьКарточкуКлиента(Клиент);
    КонецЦикла;

    ВставитьВHTML(Документ, "#clients-list", HTML);

КонецПроцедуры

&НаКлиенте
Функция ПолучитьДемоКлиентов()

    Клиенты = Новый Массив;

    Клиент1 = Новый Структура;
    Клиент1.Вставить("id", "1");
    Клиент1.Вставить("name", "Іван Петренко");
    Клиент1.Вставить("phone", "+380 67 123 4567");
    Клиент1.Вставить("email", "ivan@example.com");
    Клиент1.Вставить("badge", "vip");
    Клиент1.Вставить("badgeText", "VIP");
    Клиенты.Добавить(Клиент1);

    Клиент2 = Новый Структура;
    Клиент2.Вставить("id", "2");
    Клиент2.Вставить("name", "Марія Коваленко");
    Клиент2.Вставить("phone", "+380 50 987 6543");
    Клиент2.Вставить("email", "maria@example.com");
    Клиент2.Вставить("badge", "new");
    Клиент2.Вставить("badgeText", "Новий");
    Клиенты.Добавить(Клиент2);

    Клиент3 = Новый Структура;
    Клиент3.Вставить("id", "3");
    Клиент3.Вставить("name", "Олексій Шевченко");
    Клиент3.Вставить("phone", "+380 63 555 1234");
    Клиент3.Вставить("email", "alex@example.com");
    Клиент3.Вставить("badge", "regular");
    Клиент3.Вставить("badgeText", "Постійний");
    Клиенты.Добавить(Клиент3);

    Возврат Клиенты;

КонецФункции

&НаКлиенте
Функция СформироватьКарточкуКлиента(Клиент)

    // Отримати ініціали для аватара
    Части = СтрРазделить(Клиент.name, " ");
    Если Части.Количество() >= 2 Тогда
        Инициалы = Лев(Части[0], 1) + Лев(Части[1], 1);
    Иначе
        Инициалы = Лев(Клиент.name, 2);
    КонецЕсли;

    Шаблон = "
    |<div class=""card client-card"" onclick=""showToast('Вибрано: %2')"">
    |    <div class=""card-body"">
    |        <div class=""client-avatar"">%5</div>
    |        <div class=""client-info"">
    |            <div class=""card-title"">%2</div>
    |            <div class=""card-text"">%3</div>
    |            <div class=""card-text"">%4</div>
    |        </div>
    |        <span class=""client-badge badge-%6"">%7</span>
    |    </div>
    |</div>";

    Возврат СтрШаблон(Шаблон, Клиент.id, Клиент.name, Клиент.phone, Клиент.email, Инициалы, Клиент.badge, Клиент.badgeText);

КонецФункции

&НаКлиенте
Процедура ВыбратьКлиента(ИдКлиента, Документ)

    Клиенты = ПолучитьДемоКлиентов();

    Для Каждого Клиент Из Клиенты Цикл
        Если Клиент.id = ИдКлиента Тогда
            Сообщить("Вибрано клієнта: " + Клиент.name);
            Прервать;
        КонецЕсли;
    КонецЦикла;

КонецПроцедуры

&НаКлиенте
Процедура ВыполнитьПоиск(Запрос, Документ)

    Сообщить("Пошук: " + Запрос);

КонецПроцедуры

&НаКлиенте
Процедура ОбновитьСчетчик(Дельта, Документ)

    // Отримати поточне значення
    ТекущееЗначение = ПолучитьАтрибут(Документ, "#counter-value", "data-value");

    Если ТекущееЗначение = "" Тогда
        ТекущееЗначение = "0";
    КонецЕсли;

    НовоеЗначение = Число(ТекущееЗначение) + Число(Дельта);

    // Оновити DOM
    УстановитьТекст(Документ, "#counter-value", Строка(НовоеЗначение));
    УстановитьАтрибут(Документ, "#counter-value", "data-value", Строка(НовоеЗначение));

КонецПроцедуры

&НаКлиенте
Процедура СброситьСчетчик(Документ)

    УстановитьТекст(Документ, "#counter-value", "0");
    УстановитьАтрибут(Документ, "#counter-value", "data-value", "0");

КонецПроцедуры

// === DOM HELPERS ===

&НаКлиенте
Процедура ВставитьВHTML(Документ, Селектор, HTML)

    Элемент = Документ.querySelector(Селектор);
    Если НЕ Элемент = Null Тогда
        Элемент.innerHTML = HTML;
    КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура УстановитьТекст(Документ, Селектор, Текст)

    Элемент = Документ.querySelector(Селектор);
    Если НЕ Элемент = Null Тогда
        Элемент.textContent = Текст;
    КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура УстановитьВидимость(Документ, Селектор, Видимость)

    Элемент = Документ.querySelector(Селектор);
    Если НЕ Элемент = Null Тогда
        Если Видимость Тогда
            Элемент.style.display = "";
        Иначе
            Элемент.style.display = "none";
        КонецЕсли;
    КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура ДобавитьКласс(Документ, Селектор, ИмяКласса)

    Элемент = Документ.querySelector(Селектор);
    Если НЕ Элемент = Null Тогда
        Элемент.classList.add(ИмяКласса);
    КонецЕсли;

КонецПроцедуры

&НаКлиенте
Процедура УдалитьКласс(Документ, Селектор, ИмяКласса)

    Элемент = Документ.querySelector(Селектор);
    Если НЕ Элемент = Null Тогда
        Элемент.classList.remove(ИмяКласса);
    КонецЕсли;

КонецПроцедуры

&НаКлиенте
Функция ПолучитьАтрибут(Документ, Селектор, ИмяАтрибута)

    Элемент = Документ.querySelector(Селектор);
    Если Элемент = Null Тогда
        Возврат "";
    КонецЕсли;

    Возврат Элемент.getAttribute(ИмяАтрибута);

КонецФункции

&НаКлиенте
Процедура УстановитьАтрибут(Документ, Селектор, ИмяАтрибута, Значение)

    Элемент = Документ.querySelector(Селектор);
    Если НЕ Элемент = Null Тогда
        Элемент.setAttribute(ИмяАтрибута, Значение);
    КонецЕсли;

КонецПроцедуры

// === JSON HELPER ===

&НаКлиенте
Функция ПрочитатьДанныеИзJSON(СтрокаJSON)

    Попытка
        ЧтениеJSON = Новый ЧтениеJSON;
        ЧтениеJSON.УстановитьСтроку(СтрокаJSON);
        Результат = ПрочитатьJSON(ЧтениеJSON);
        ЧтениеJSON.Закрыть();
        Возврат Результат;
    Исключение
        Возврат Неопределено;
    КонецПопытки;

КонецФункции
