// TaskManager - Task Management Example Handlers
// Demonstrates: Master-Detail, CRUD operations, Status filtering, Priority indicators

// ============================================
// Form Events
// ============================================

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	// Initialize filters
	Объект.ФильтрСтатус = "";
	Объект.ФильтрПриоритет = "";
	Объект.ПоказыватьЗавершенные = Ложь;

	// Load demo data
	ЗагрузитьДемоДанныеНаСервере();

	// Apply initial filter
	ПрименитьФильтрНаСервере();
КонецПроцедуры

// ============================================
// Table Events
// ============================================

&НаКлиенте
Процедура СписокЗадачПриАктивизацииСтроки(Элемент)
	// Master-Detail: Update detail panel when row changes
	ОбновитьДеталиСписокЗадачНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура СписокЗадачВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	// Double-click opens edit
	РедактироватьЗадачуКоманда(Неопределено);
КонецПроцедуры

// ============================================
// Filter Events
// ============================================

&НаКлиенте
Процедура ФильтрИзменен(Элемент)
	ПрименитьФильтрНаСервере();
КонецПроцедуры

// ============================================
// Command Handlers
// ============================================

&НаКлиенте
Процедура ДобавитьЗадачуКоманда(Команда)
	ДобавитьЗадачуНаСервере();
КонецПроцедуры

&НаСервере
Процедура ДобавитьЗадачуНаСервере()
	// Create new task
	НоваяСтрока = СписокЗадач.Добавить();
	НоваяСтрока.Номер = СписокЗадач.Количество();
	НоваяСтрока.Название = "Новая задача";
	НоваяСтрока.Описание = "";
	НоваяСтрока.Статус = "Новая";
	НоваяСтрока.Приоритет = "Средний";
	НоваяСтрока.Срок = ТекущаяДата() + 7 * 86400; // +7 days
	НоваяСтрока.Создана = ТекущаяДата();

	// Select new row
	Элементы.ТаблицаСписокЗадач.ТекущаяСтрока = НоваяСтрока.ПолучитьИдентификатор();

	// Update statistics
	ОбновитьСтатистикуНаСервере();
	ОбновитьДеталиСписокЗадачНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура РедактироватьЗадачуКоманда(Команда)
	ТекущиеДанные = Элементы.ТаблицаСписокЗадач.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;

	// In real app: open modal form for editing
	// For demo: just show message
	Сообщить("Редактирование задачи: " + ТекущиеДанные.Название);
КонецПроцедуры

&НаКлиенте
Процедура УдалитьЗадачуКоманда(Команда)
	ТекущиеДанные = Элементы.ТаблицаСписокЗадач.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;

	// Delete selected task
	СписокЗадач.Удалить(ТекущиеДанные);

	// Update UI
	ОбновитьСтатистикуНаСервере();
	ОбновитьДеталиСписокЗадачНаСервере();
КонецПроцедуры

&НаКлиенте
Процедура ВзятьВРаботуКоманда(Команда)
	ТекущиеДанные = Элементы.ТаблицаСписокЗадач.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;

	Если ТекущиеДанные.Статус = "Новая" Тогда
		ТекущиеДанные.Статус = "В работе";
		ОбновитьДеталиСписокЗадачНаСервере();
		ОбновитьСтатистикуНаСервере();
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ЗавершитьЗадачуКоманда(Команда)
	ТекущиеДанные = Элементы.ТаблицаСписокЗадач.ТекущиеДанные;
	Если ТекущиеДанные = Неопределено Тогда
		Возврат;
	КонецЕсли;

	Если ТекущиеДанные.Статус <> "Завершена" Тогда
		ТекущиеДанные.Статус = "Завершена";
		ЗавершитьЗадачуНаСервере();
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура ЗавершитьЗадачуНаСервере()
	ТекущаяСтрока = Элементы.ТаблицаСписокЗадач.ТекущаяСтрока;
	Если ТекущаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;

	ДанныеСтроки = СписокЗадач.НайтиПоИдентификатору(ТекущаяСтрока);
	Если ДанныеСтроки <> Неопределено Тогда
		ДанныеСтроки.Завершена = ТекущаяДата();
	КонецЕсли;

	ОбновитьДеталиСписокЗадачНаСервере();
	ОбновитьСтатистикуНаСервере();

	// Re-apply filter (may hide completed task)
	Если НЕ Объект.ПоказыватьЗавершенные Тогда
		ПрименитьФильтрНаСервере();
	КонецЕсли;
КонецПроцедуры

// ============================================
// Helper Procedures
// ============================================

&НаСервере
Процедура ЗагрузитьДемоДанныеНаСервере()
	// Demo tasks
	ДобавитьЗадачу(1, "Подготовить отчет за квартал", "Собрать данные по продажам и подготовить презентацию", "В работе", "Высокий", ТекущаяДата() + 3 * 86400);
	ДобавитьЗадачу(2, "Провести встречу с клиентом", "Обсудить новые требования к проекту", "Новая", "Высокий", ТекущаяДата() + 1 * 86400);
	ДобавитьЗадачу(3, "Обновить документацию", "Актуализировать техническую документацию", "Новая", "Средний", ТекущаяДата() + 14 * 86400);
	ДобавитьЗадачу(4, "Оптимизировать базу данных", "Провести анализ и оптимизацию запросов", "В работе", "Средний", ТекущаяДата() + 7 * 86400);
	ДобавитьЗадачу(5, "Проверить логи ошибок", "Просмотреть логи за последнюю неделю", "Завершена", "Низкий", ТекущаяДата() - 2 * 86400);
	ДобавитьЗадачу(6, "Настроить резервное копирование", "Проверить и обновить расписание бэкапов", "Завершена", "Высокий", ТекущаяДата() - 5 * 86400);

	ОбновитьСтатистикуНаСервере();
КонецПроцедуры

&НаСервере
Процедура ДобавитьЗадачу(Номер, Название, Описание, Статус, Приоритет, Срок)
	НоваяСтрока = СписокЗадач.Добавить();
	НоваяСтрока.Номер = Номер;
	НоваяСтрока.Название = Название;
	НоваяСтрока.Описание = Описание;
	НоваяСтрока.Статус = Статус;
	НоваяСтрока.Приоритет = Приоритет;
	НоваяСтрока.Срок = Срок;
	НоваяСтрока.Создана = ТекущаяДата() - 10 * 86400; // Created 10 days ago
	Если Статус = "Завершена" Тогда
		НоваяСтрока.Завершена = ТекущаяДата() - 1 * 86400;
	КонецЕсли;
КонецПроцедуры

&НаСервере
Процедура ПрименитьФильтрНаСервере()
	// Build filter structure
	СтруктураОтбора = Новый Структура;

	Если ЗначениеЗаполнено(Объект.ФильтрСтатус) Тогда
		СтруктураОтбора.Вставить("Статус", Объект.ФильтрСтатус);
	КонецЕсли;

	Если ЗначениеЗаполнено(Объект.ФильтрПриоритет) Тогда
		СтруктураОтбора.Вставить("Приоритет", Объект.ФильтрПриоритет);
	КонецЕсли;

	// Apply row filter
	Элементы.ТаблицаСписокЗадач.ОтборСтрок = Новый ФиксированнаяСтруктура(СтруктураОтбора);

	// Note: "ПоказыватьЗавершенные" filter would require more complex logic
	// For demo purposes, it's simplified
КонецПроцедуры

&НаСервере
Процедура ОбновитьДеталиСписокЗадачНаСервере()
	ТекущаяСтрока = Элементы.ТаблицаСписокЗадач.ТекущаяСтрока;
	Если ТекущаяСтрока = Неопределено Тогда
		// Clear detail panel
		Объект.ВыбраннаяЗадачаНомер = 0;
		Объект.ВыбраннаяЗадачаНазвание = "";
		Объект.ВыбраннаяЗадачаОписание = "";
		Объект.ВыбраннаяЗадачаСтатус = "";
		Объект.ВыбраннаяЗадачаПриоритет = "";
		Объект.ВыбраннаяЗадачаСрок = '00010101';
		Объект.ВыбраннаяЗадачаСоздана = '00010101';
		Возврат;
	КонецЕсли;

	// Find task by row ID
	ДанныеСтроки = СписокЗадач.НайтиПоИдентификатору(ТекущаяСтрока);
	Если ДанныеСтроки = Неопределено Тогда
		Возврат;
	КонецЕсли;

	// Update detail panel
	Объект.ВыбраннаяЗадачаНомер = ДанныеСтроки.Номер;
	Объект.ВыбраннаяЗадачаНазвание = ДанныеСтроки.Название;
	Объект.ВыбраннаяЗадачаОписание = ДанныеСтроки.Описание;
	Объект.ВыбраннаяЗадачаСтатус = ДанныеСтроки.Статус;
	Объект.ВыбраннаяЗадачаПриоритет = ДанныеСтроки.Приоритет;
	Объект.ВыбраннаяЗадачаСрок = ДанныеСтроки.Срок;
	Объект.ВыбраннаяЗадачаСоздана = ДанныеСтроки.Создана;
КонецПроцедуры

&НаСервере
Процедура ОбновитьСтатистикуНаСервере()
	Объект.ВсегоЗадач = СписокЗадач.Количество();
	Объект.Активных = 0;
	Объект.Завершенных = 0;

	Для Каждого Строка Из СписокЗадач Цикл
		Если Строка.Статус = "Завершена" Тогда
			Объект.Завершенных = Объект.Завершенных + 1;
		Иначе
			Объект.Активных = Объект.Активных + 1;
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры
