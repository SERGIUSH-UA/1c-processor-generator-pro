// SimpleDashboard - KPI Dashboard Example Handlers
// Demonstrates: Loading State, KPI cards with colored trends

// ============================================
// Form Events
// ============================================

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	// Initialize default period (current month)
	Объект.ПериодС = НачалоМесяца(ТекущаяДата());
	Объект.ПериодПо = КонецМесяца(ТекущаяДата());

	// Load initial data and update trends
	ЗагрузитьДанныеНаСервере();
	ОбновитьТрендыНаСервере();

	// Switch to content page (hide loading)
	Элементы.СтраницыКонтент.ТекущаяСтраница = Элементы.СтраницаПоказатели;
КонецПроцедуры

// ============================================
// Element Events
// ============================================

&НаКлиенте
Процедура ПериодИзменен(Элемент)
	// Reload data when period changes
	ОбновитьВсеНаСервере();
КонецПроцедуры

// ============================================
// Command Handlers
// ============================================

&НаКлиенте
Процедура ОбновитьДанные(Команда)
	// Show loading state
	Элементы.СтраницыКонтент.ТекущаяСтраница = Элементы.СтраницаЗагрузка;

	// Refresh data on server
	ОбновитьВсеНаСервере();

	// Show content
	Элементы.СтраницыКонтент.ТекущаяСтраница = Элементы.СтраницаПоказатели;
КонецПроцедуры

// ============================================
// Server Procedures
// ============================================

&НаСервере
Процедура ОбновитьВсеНаСервере()
	ЗагрузитьДанныеНаСервере();
	ОбновитьТрендыНаСервере();
КонецПроцедуры

&НаСервере
Процедура ЗагрузитьДанныеНаСервере()
	// Demo data - in real app this would query database
	Объект.ВсегоПродаж = 1234567.89;
	Объект.КоличествоЗаказов = 456;
	Объект.СреднийЧек = 2706.95;
	Объект.Конверсия = 3.45;

	// Demo trends
	Объект.ТрендПродаж = "up";
	Объект.ИзменениеПродаж = 12.5;

	Объект.ТрендЗаказов = "down";
	Объект.ИзменениеЗаказов = -3.2;

	Объект.ТрендЧека = "stable";
	Объект.ИзменениеЧека = 0.0;

	Объект.ТрендКонверсии = "up";
	Объект.ИзменениеКонверсии = 5.8;
КонецПроцедуры

&НаСервере
Процедура ОбновитьТрендыНаСервере()
	// Update trend labels with colored FormattedString
	ОбновитьТрендМетку("ТрендПродажи", Объект.ТрендПродаж, Объект.ИзменениеПродаж);
	ОбновитьТрендМетку("ТрендЗаказы", Объект.ТрендЗаказов, Объект.ИзменениеЗаказов);
	ОбновитьТрендМетку("ТрендЧек", Объект.ТрендЧека, Объект.ИзменениеЧека);
	ОбновитьТрендМетку("ТрендКонверсия", Объект.ТрендКонверсии, Объект.ИзменениеКонверсии);
КонецПроцедуры

&НаСервере
Процедура ОбновитьТрендМетку(ИмяЭлемента, Тренд, Изменение)
	// Determine arrow, color and sign based on trend
	Если Тренд = "up" Тогда
		Стрелка = "↑";
		Цвет = WebЦвета.Зеленый;
		Знак = "+";
	ИначеЕсли Тренд = "down" Тогда
		Стрелка = "↓";
		Цвет = WebЦвета.Красный;
		Знак = "";
	Иначе
		Стрелка = "→";
		Цвет = WebЦвета.Серый;
		Знак = "";
	КонецЕсли;

	// Build formatted text
	ТекстТренда = Стрелка + " " + Знак + Формат(?(Изменение < 0, -Изменение, Изменение), "ЧДЦ=1") + "%";

	// Create FormattedString with color
	Элементы[ИмяЭлемента].Заголовок = Новый ФорматированнаяСтрока(
		ТекстТренда,
		Новый Шрифт(,,Истина),
		Цвет);
КонецПроцедуры
